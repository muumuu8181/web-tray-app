<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">Novel AI ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ã‚¢ãƒ—ãƒª - èª­ã¿è¾¼ã¿ä¸­</title>
    
    <!-- ğŸ¯ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€å…ƒç®¡ç† -->
    <script>
        const APP_VERSION = 'v1.02';
        const APP_TITLE = 'æ§‹æ–‡ã‚¨ãƒ©ãƒ¼æ®µéšä¿®æ­£ç‰ˆ';
        
        // ãƒ–ãƒ©ã‚¦ã‚¶ã‚µã‚¤ã‚ºè¡¨ç¤ºæ©Ÿèƒ½
        function updateBrowserSize() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const sizeDisplay = document.getElementById('size-display');
            if (sizeDisplay) {
                // 700x1000ç¨‹åº¦ãªã‚‰ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆåˆ¤å®š
                const isTablet = (width >= 600 && width <= 900) && (height >= 900 && height <= 1200);
                const deviceInfo = isTablet ? ' (Tablet)' : '';
                sizeDisplay.textContent = `${width}Ã—${height}px${deviceInfo} | clip4ä½œæˆä¸­`;
            }
        }
        
        // çµ±åˆåˆæœŸåŒ–å‡¦ç†ï¼ˆDOMContentLoadedç«¶åˆè§£æ±ºï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ çµ±åˆåˆæœŸåŒ–é–‹å§‹');
            
            // Step1: ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
            document.title = `Novel AI ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ã‚¢ãƒ—ãƒª ${APP_VERSION} - ${APP_TITLE}`;
            document.getElementById('app-title').textContent = document.title;
            
            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒƒã‚¸æ›´æ–°
            const versionBadge = document.querySelector('.version-badge');
            if (versionBadge) {
                versionBadge.textContent = APP_VERSION;
            }
            
            // ã‚µã‚¤ã‚ºè¡¨ç¤ºåˆæœŸåŒ–
            updateBrowserSize();
            
            console.log('âœ… Step1å®Œäº†: ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°');
            
            // Step2: Claude Codeã‚¿ãƒ–ã®å‹•çš„è¿½åŠ 
            const novelAiTab = document.getElementById('novel-ai-tab');
            if (novelAiTab) {
                const claudeCodeTab = document.createElement('div');
                claudeCodeTab.id = 'claude-code-tab';
                claudeCodeTab.className = 'tab-content';
                claudeCodeTab.innerHTML = `
                    <!-- ğŸ’» ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›ãƒ‘ãƒãƒ« -->
                    <div style="border: 5px solid #7B68EE; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: linear-gradient(135deg, #f8f6ff 0%, #ede7ff 100%); box-shadow: 0 4px 8px rgba(123, 104, 238, 0.3);">
                        <h3 style="margin-top: 0; color: #7B68EE; font-size: 1.2em;">ğŸ’» ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›ãƒ‘ãƒãƒ«</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #444;">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:</label>
                            <textarea id="claude-prompt" rows="8" placeholder="Claude Codeã§ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›..." style="width: 100%; padding: 12px; border: 2px solid #7B68EE; border-radius: 8px; resize: vertical; font-size: 14px;"></textarea>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #444;">ã‚«ãƒ†ã‚´ãƒª:</label>
                            <select id="claude-category" style="width: 100%; padding: 12px; border: 2px solid #7B68EE; border-radius: 8px; font-size: 14px;">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ">ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</option>
                                <option value="ãƒ‡ãƒãƒƒã‚°">ãƒ‡ãƒãƒƒã‚°</option>
                                <option value="ãƒ¬ãƒ“ãƒ¥ãƒ¼">ãƒ¬ãƒ“ãƒ¥ãƒ¼</option>
                                <option value="ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°">ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°</option>
                                <option value="è³ªå•">è³ªå•</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <button onclick="saveClaude()" style="background: linear-gradient(135deg, #7B68EE 0%, #9370DB 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">ä¿å­˜</button>
                    </div>
                `;
                
                novelAiTab.parentNode.insertBefore(claudeCodeTab, novelAiTab.nextSibling);
                console.log('âœ… Step2å®Œäº†: Claude Codeã‚¿ãƒ–è¿½åŠ ');
            }
            
            // Step3: ã‚¿ãƒ–çŠ¶æ…‹å¾©å…ƒ
            setTimeout(() => {
                const savedTab = localStorage.getItem('currentTab') || 'yarakashi';
                console.log(`ğŸ”„ Step3: ã‚¿ãƒ–çŠ¶æ…‹å¾©å…ƒ - ${savedTab}`);
                switchTab(savedTab);
                console.log('âœ… Step3å®Œäº†: ã‚¿ãƒ–å¾©å…ƒ');
            }, 100);
        });
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«ã‚µã‚¤ã‚ºæ›´æ–°
        window.addEventListener('resize', updateBrowserSize);
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function switchTab(tabName) {
            console.log('ğŸ”„ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ:', tabName);
            
            // å…¨ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // å…¨ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–
            const allButtons = document.querySelectorAll('.tab-button');
            allButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // æŒ‡å®šã•ã‚ŒãŸã‚¿ãƒ–ã‚’è¡¨ç¤º
            const targetTab = document.getElementById(tabName + '-tab');
            const targetButton = document.querySelector(`[data-tab="${tabName}"]`);
            
            if (targetTab) {
                targetTab.classList.add('active');
                console.log('âœ… ã‚¿ãƒ–è¡¨ç¤º:', tabName);
            } else {
                console.error('âŒ ã‚¿ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', tabName);
            }
            
            if (targetButton) {
                targetButton.classList.add('active');
                console.log('âœ… ãƒœã‚¿ãƒ³ã‚¢ã‚¯ãƒ†ã‚£ãƒ–:', tabName);
            } else {
                console.error('âŒ ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', tabName);
            }
            
            // ã‚¿ãƒ–çŠ¶æ…‹ã‚’ä¿å­˜
            localStorage.setItem('currentTab', tabName);
        }
    </script>
    
    <!-- ğŸ”¥ Firebase Test Integration - Phase 1-2 -->
    <script type="module">
        // Firebase SDKèª­ã¿è¾¼ã¿ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, onValue, set, push, get } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

        // Firebaseè¨­å®šï¼ˆå‰ä»»è€…ã‹ã‚‰ç¶™æ‰¿ï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyA5PXKChizYDCXF_GJ4KL6Ylq9K5hCPXWE",
            authDomain: "shares-b1b97.firebaseapp.com",
            databaseURL: "https://shares-b1b97-default-rtdb.firebaseio.com",
            projectId: "shares-b1b97",
            storageBucket: "shares-b1b97.firebasestorage.app",
            messagingSenderId: "38311063248",
            appId: "1:38311063248:web:0d2d5726d12b305b24b8d5"
        };

        console.log('ğŸ”¥ Firebase Test Phase 1-2 é–‹å§‹');
        console.log('ğŸŒ Protocol:', window.location.protocol);
        console.log('ğŸŒ Host:', window.location.host);
        
        try {
            // FirebaseåˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);
            const auth = getAuth(app);
            const googleProvider = new GoogleAuthProvider();
            
            console.log('âœ… Firebase SDKåˆæœŸåŒ–æˆåŠŸ');
            console.log('âœ… Databaseæ¥ç¶šæº–å‚™å®Œäº†');
            console.log('âœ… Authæ¥ç¶šæº–å‚™å®Œäº†');
            
            // Phase1-3: èªè¨¼çŠ¶æ…‹ç›£è¦–ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
            let currentUser = null;
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log('ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª:', user.email);
                    currentUser = user;
                    window.updateAuthUI(true);
                } else {
                    console.log('ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹');
                    currentUser = null;
                    window.updateAuthUI(false);
                }
            });
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨ï¼ˆãƒ†ã‚¹ãƒˆç”¨ã®ã¿ï¼‰
            window.firebaseTest = {
                app,
                database,
                auth,
                googleProvider,
                ref,
                set,
                get,
                signIn: () => signInWithPopup(auth, googleProvider),
                signOut: () => signOut(auth),
                getCurrentUser: () => currentUser,
                // Phase1-4: ç°¡å˜ãªDBæ“ä½œé–¢æ•°è¿½åŠ ï¼ˆä¿®æ­£ç‰ˆï¼šFirebase UIDã‚’ä½¿ç”¨ï¼‰
                saveTestData: async (data) => {
                    if (!currentUser) {
                        throw new Error('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                    }
                    const userId = currentUser.uid; // UIDä½¿ç”¨ã«å¤‰æ›´
                    const testRef = ref(database, `users/${userId}/novel_ai_prompts/test_data`);
                    await set(testRef, {
                        ...data,
                        timestamp: new Date().toISOString(),
                        userEmail: currentUser.email,
                        userId: currentUser.uid
                    });
                },
                loadTestData: async () => {
                    if (!currentUser) {
                        throw new Error('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                    }
                    const userId = currentUser.uid; // UIDä½¿ç”¨ã«å¤‰æ›´
                    const testRef = ref(database, `users/${userId}/novel_ai_prompts/test_data`);
                    const snapshot = await get(testRef);
                    return snapshot.exists() ? snapshot.val() : null;
                },
                initialized: true,
                phase: 'Phase1-4',
                safeMode: true
            };
            
            console.log('ğŸ”¥ Firebase Test Phase1-4 - DBèª­ã¿æ›¸ããƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†ã€‚');
            console.log('âš ï¸  æ³¨æ„: ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã¯ã¾ã localStorageã‚’ä½¿ç”¨ä¸­ï¼ˆFirebaseãƒ‡ãƒ¼ã‚¿ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ï¼‰');
            
        } catch (error) {
            console.error('âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            window.firebaseTest = { error: error.message, initialized: false };
        }
        
        // Phase1-3: UIæ›´æ–°é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
        window.updateAuthUI = function(isLoggedIn) {
            const authStatus = document.getElementById('auth-status');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            
            if (authStatus && loginBtn && logoutBtn) {
                if (isLoggedIn) {
                    authStatus.textContent = `âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${window.firebaseTest.getCurrentUser().email}`;
                    authStatus.style.color = 'green';
                    loginBtn.style.display = 'none';
                    logoutBtn.style.display = 'inline-block';
                    
                    // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ã‚„ã‚‰ã‹ã—ãƒªã‚¹ãƒˆã€èª²é¡Œãƒªã‚¹ãƒˆã€Claude ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
                    setTimeout(() => {
                        window.loadYarakashiList();
                        window.loadIssuesList();
                        window.loadClaudePrompts();
                    }, 1000);
                    
                } else {
                    authStatus.textContent = 'ğŸ” ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹';
                    authStatus.style.color = 'orange';
                    loginBtn.style.display = 'inline-block';
                    logoutBtn.style.display = 'none';
                    
                    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«ã‚„ã‚‰ã‹ã—ãƒªã‚¹ãƒˆã€èª²é¡Œãƒªã‚¹ãƒˆã€Claudeãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¯ãƒªã‚¢
                    yarakashiList = [];
                    issuesList = [];
                    claudePrompts = [];
                    window.yarakashiList = yarakashiList;
                    window.issuesList = issuesList;
                    window.claudePrompts = claudePrompts;
                    displayYarakashiList();
                    displayIssuesList();
                    displayClaudePrompts();
                }
            }
        }
        
        // Phase1-3: èªè¨¼ãƒ†ã‚¹ãƒˆé–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
        window.testLogin = async function() {
            try {
                console.log('ğŸ” Googleèªè¨¼ãƒ†ã‚¹ãƒˆé–‹å§‹');
                
                // Protocolç¢ºèª
                if (window.location.protocol === 'file:') {
                    console.log('âš ï¸  file://ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§å®Ÿè¡Œä¸­');
                    alert('âš ï¸ Firebaseèªè¨¼ã«ã¯HTTP/HTTPSãŒå¿…è¦ã§ã™\n\næ¬¡ã®æ‰‹é †ã‚’ãŠè©¦ã—ãã ã•ã„:\n1. Windowsã§ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é–‹ã\n2. ãƒ†ã‚¹ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•\n3. python -m http.server 8083\n4. http://localhost:8083/test.html ã§ã‚¢ã‚¯ã‚»ã‚¹');
                    return;
                }
                
                await window.firebaseTest.signIn();
                console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ');
            } catch (error) {
                console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error.message);
                if (error.message.includes('auth/unauthorized-domain')) {
                    alert('ğŸ”§ Firebaseè¨­å®šã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ‰¿èªãŒå¿…è¦ã§ã™ã€‚\nç¾åœ¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³: ' + window.location.origin);
                } else {
                    alert('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            }
        };
        
        window.testLogout = async function() {
            try {
                console.log('ğŸ” ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ†ã‚¹ãƒˆé–‹å§‹');
                await window.firebaseTest.signOut();
                console.log('âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ');
            } catch (error) {
                console.error('âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error.message);
            }
        };
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ï¼ˆçŠ¶æ…‹è¨˜æ†¶ä»˜ãï¼‰
        let currentTab = localStorage.getItem('currentTab') || 'yarakashi';
        
        window.switchTab = function(tabName) {
            console.log(`ğŸ”„ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ: ${currentTab} â†’ ${tabName}`);
            
            // å…¨ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            // å…¨ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æŒ‡å®šã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
            const targetTab = document.getElementById(`${tabName}-tab`);
            const targetButton = document.querySelector(`[data-tab="${tabName}"]`);
            
            if (targetTab && targetButton) {
                targetTab.classList.add('active');
                targetTab.style.display = 'block';
                targetButton.classList.add('active');
                
                // ã‚¿ãƒ–çŠ¶æ…‹ã‚’localStorageã«ä¿å­˜
                localStorage.setItem('currentTab', tabName);
                currentTab = tabName;
                console.log(`âœ… ${tabName}ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆå®Œäº†`);
                
                // è¿½åŠ ã®è¡¨ç¤ºç¢ºèªãƒ­ã‚°
                console.log(`ğŸ” ${tabName}-tab è¡¨ç¤ºçŠ¶æ…‹:`, targetTab.style.display);
                console.log(`ğŸ” ${tabName}-tab ã‚¯ãƒ©ã‚¹:`, targetTab.className);
            } else {
                console.error(`âŒ ã‚¿ãƒ–è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${tabName}`);
                console.log('ğŸ” åˆ©ç”¨å¯èƒ½ãªã‚¿ãƒ–:', Array.from(document.querySelectorAll('[id$="-tab"]')).map(t => t.id));
                console.log('ğŸ” åˆ©ç”¨å¯èƒ½ãªãƒœã‚¿ãƒ³:', Array.from(document.querySelectorAll('[data-tab]')).map(b => b.getAttribute('data-tab')));
                
                // è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®è©³ç´°ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                if (!targetTab) {
                    console.error(`âŒ ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: #${tabName}-tab`);
                }
                if (!targetButton) {
                    console.error(`âŒ ã‚¿ãƒ–ãƒœã‚¿ãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: [data-tab="${tabName}"]`);
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚„ã‚‰ã‹ã—ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
                if (tabName !== 'yarakashi') {
                    console.log('ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚„ã‚‰ã‹ã—ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ');
                    setTimeout(() => window.switchTab('yarakashi'), 100);
                }
            }
        };
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®çµ±ä¸€åˆæœŸåŒ–å‡¦ç†ï¼ˆv0.95ä¿®æ­£ç‰ˆï¼‰
        
        // ğŸ” å…±é€šæ¤œç´¢é–¢æ•°ï¼ˆè»Šè¼ªã®å†ç™ºæ˜è§£æ¶ˆï¼‰
        window.universalSearch = function(dataArray, searchQuery, searchFields) {
            if (!searchQuery || !searchQuery.trim()) {
                return [...dataArray];
            }
            
            const query = searchQuery.trim().toLowerCase();
            console.log(`ğŸ” å…±é€šæ¤œç´¢å®Ÿè¡Œ: "${query}" in fields:`, searchFields);
            
            return dataArray.filter(item => 
                searchFields.some(field => {
                    const value = item[field] || '';
                    return value.toString().toLowerCase().includes(query);
                })
            );
        };
        
        // ã‚„ã‚‰ã‹ã—ãƒªã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½
        let yarakashiList = [];
        window.yarakashiList = yarakashiList;
        
        window.addYarakashi = async function() {
            try {
                const title = document.getElementById('yarakashi-title').value.trim();
                const category = document.getElementById('yarakashi-category').value;
                const content = document.getElementById('yarakashi-content').value.trim();
                
                if (!title || !content) {
                    alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨è©³ç´°å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                const yarakashi = {
                    id: `yarakashi_${Date.now()}_${Math.floor(Math.random() * 10000)}`,
                    title,
                    category,
                    content,
                    timestamp: new Date().toISOString(),
                    resolved: false
                };
                
                console.log('ğŸš¨ ã‚„ã‚‰ã‹ã—è¿½åŠ é–‹å§‹:', yarakashi.title);
                
                if (window.firebaseTest && window.firebaseTest.getCurrentUser()) {
                    const user = window.firebaseTest.getCurrentUser();
                    const yarakashiRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/yarakashi_list/${yarakashi.id}`);
                    await window.firebaseTest.set(yarakashiRef, yarakashi);
                    console.log('âœ… Firebaseä¿å­˜æˆåŠŸ');
                }
                
                yarakashiList.push(yarakashi);
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('yarakashi-title').value = '';
                document.getElementById('yarakashi-content').value = '';
                
                displayYarakashiList();
                console.log('âœ… ã‚„ã‚‰ã‹ã—è¿½åŠ å®Œäº†');
                
            } catch (error) {
                console.error('âŒ ã‚„ã‚‰ã‹ã—è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error.message);
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        };
        
        window.loadYarakashiList = async function() {
            try {
                if (!window.firebaseTest || !window.firebaseTest.getCurrentUser()) {
                    console.log('âš ï¸  ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                console.log('ğŸ“– ã‚„ã‚‰ã‹ã—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹');
                const user = window.firebaseTest.getCurrentUser();
                const yarakashiRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/yarakashi_list`);
                const snapshot = await window.firebaseTest.get(yarakashiRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    yarakashiList = Object.values(data).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    window.yarakashiList = yarakashiList; // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒæœŸ
                    console.log('âœ… ã‚„ã‚‰ã‹ã—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿æˆåŠŸ:', yarakashiList.length, 'ä»¶');
                    console.log('ğŸ” èª­ã¿è¾¼ã¿ãƒ‡ãƒ¼ã‚¿:', yarakashiList.map(y => y.title));
                } else {
                    yarakashiList = [];
                    window.yarakashiList = yarakashiList;
                    console.log('ğŸ“­ ã‚„ã‚‰ã‹ã—ãƒªã‚¹ãƒˆãªã—');
                }
                
                displayYarakashiList();
                
            } catch (error) {
                console.error('âŒ ã‚„ã‚‰ã‹ã—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error.message);
            }
        };
        
        // ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨ã®å¤‰æ•°
        let filteredYarakashiList = [...yarakashiList];
        
        function displayYarakashiList(searchQuery = '') {
            console.log('ğŸ–¼ï¸  displayYarakashiListé–‹å§‹');
            console.log('ğŸ” yarakashiList.length:', yarakashiList.length);
            console.log('ğŸ” searchQuery:', searchQuery);
            
            const listContainer = document.getElementById('yarakashi-list');
            const totalCountElement = document.getElementById('total-count');
            const searchResultElement = document.getElementById('yarakashi-search-result');
            
            if (!listContainer) {
                console.error('âŒ yarakashi-listè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ğŸ” æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå…±é€šé–¢æ•°ä½¿ç”¨ï¼‰
            filteredYarakashiList = window.universalSearch(yarakashiList, searchQuery, ['title', 'content', 'category']);
            
            // ğŸ“Š æ¤œç´¢çµæœè¡¨ç¤ºæ›´æ–°
            if (totalCountElement) totalCountElement.textContent = filteredYarakashiList.length;
            if (searchResultElement) {
                searchResultElement.innerHTML = searchQuery ? 
                    `æ¤œç´¢çµæœ: <span style="color: #2196F3; font-weight: bold;">${filteredYarakashiList.length}</span> ä»¶ / å…¨ ${yarakashiList.length} ä»¶` :
                    `å…¨ <span id="total-count">${yarakashiList.length}</span> ä»¶`;
            }
            
            if (filteredYarakashiList.length === 0) {
                const message = searchQuery ? 
                    `<div style="text-align: center; padding: 8px; color: #666;">ã€Œ${searchQuery}ã€ã«ä¸€è‡´ã™ã‚‹ã‚„ã‚‰ã‹ã—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>` :
                    '<div style="text-align: center; padding: 8px; color: #666;">ã‚„ã‚‰ã‹ã—ãƒªã‚¹ãƒˆã¯ç©ºã§ã™</div>';
                listContainer.innerHTML = message;
                return;
            }
            
            console.log('ğŸ”„ HTMLç”Ÿæˆé–‹å§‹...');
            const html = filteredYarakashiList.map((yarakashi, index) => {
                console.log(`ğŸ” [${index}] ID: ${yarakashi.id}, Title: ${yarakashi.title}`);
                
                const resolveButton = !yarakashi.resolved ? 
                    '' : 
                    `<button onclick="unresolveYarakashi('${yarakashi.id}')" style="background: #FF9800; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">æœªè§£æ±ºã«æˆ»ã™</button>`;
                
                // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
                const escapeHtml = (text) => {
                    return text.replace(/&/g, '&amp;')
                              .replace(/</g, '&lt;')
                              .replace(/>/g, '&gt;')
                              .replace(/"/g, '&quot;')
                              .replace(/'/g, '&#39;')
                              .replace(/`/g, '&#96;');
                };
                
                const safeTitle = escapeHtml(yarakashi.title);
                const safeCategory = escapeHtml(yarakashi.category);
                
                // ğŸ“Š ã‚³ãƒ³ãƒ†ãƒ³ãƒ„çµ±è¨ˆè¨ˆç®—
                const contentLines = yarakashi.content.split('\n').length;
                const contentChars = yarakashi.content.length;
                const firstLine = yarakashi.content.split('\n')[0];
                const safeFirstLine = escapeHtml(firstLine);
                
                // ğŸ” ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºç”¨ã®è¦ç´ ID
                const itemId = yarakashi.id;
                
                return `<div class="yarakashi-item ${yarakashi.resolved ? 'resolved' : ''}" data-id="${yarakashi.id}">
                    <div class="yarakashi-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div class="yarakashi-title">${safeTitle}</div>
                        <div class="yarakashi-stats" style="font-size: 11px; color: #999; white-space: nowrap;">
                            ğŸ“ ${contentLines}è¡Œ | ${contentChars}æ–‡å­—
                        </div>
                    </div>
                    <div class="yarakashi-meta">
                        ğŸ“… ${new Date(yarakashi.timestamp).toLocaleDateString('ja-JP')} 
                        ğŸ“‚ ${safeCategory}
                        ${yarakashi.resolved ? 'âœ… è§£æ±ºæ¸ˆã¿' : 'ğŸš¨ æœªè§£æ±º'}
                    </div>
                    <div class="yarakashi-preview" style="color: #666; font-size: 14px; margin: 8px 0;">
                        ${safeFirstLine}${contentLines > 1 ? ' ...' : ''}
                    </div>
                    <div class="yarakashi-actions" style="margin-top: 10px;">
                        <button onclick="toggleYarakashiContent('${itemId}')" style="background: #2196F3; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                            <span id="toggle-text-${itemId}">è©³ç´°è¡¨ç¤º</span>
                        </button>
                        ${resolveButton}
                        <button onclick="deleteYarakashi('${yarakashi.id}')" style="background: #f44336; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px;">å‰Šé™¤</button>
                    </div>
                    <div id="full-content-${itemId}" class="yarakashi-full-content" style="display: none; margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 6px; font-size: 14px;">
                        ${escapeHtml(yarakashi.content).replace(/\n/g, '<br>')}
                    </div>
                </div>`;
            }).join('');
            
            console.log('ğŸ” ç”Ÿæˆã•ã‚ŒãŸHTMLæ–‡å­—æ•°:', html.length);
            console.log('ğŸ” HTML preview:', html.substring(0, 200) + '...');
            console.log('ğŸ” Full HTML:', html);
            
            listContainer.innerHTML = html;
            console.log('âœ… innerHTMLè¨­å®šå®Œäº†');
            
            // DOMæ›´æ–°å¾Œã®ç¢ºèª
            setTimeout(() => {
                const renderedItems = document.querySelectorAll('.yarakashi-item');
                console.log('âœ… å®Ÿéš›ã«æç”»ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ æ•°:', renderedItems.length);
                console.log('ğŸ” æç”»ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ :', Array.from(renderedItems).map(item => item.dataset.id));
                
                // ã‚ˆã‚Šè©³ç´°ãªDOMç¢ºèª
                const listContainer = document.getElementById('yarakashi-list');
                console.log('ğŸ” listContainer.children.length:', listContainer.children.length);
                console.log('ğŸ” listContainer.innerHTML.length:', listContainer.innerHTML.length);
                console.log('ğŸ” listContainer styles:', window.getComputedStyle(listContainer));
                
                // å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ ã®ç¢ºèª
                for (let i = 0; i < renderedItems.length; i++) {
                    const item = renderedItems[i];
                    console.log(`ğŸ” Item ${i}:`, {
                        id: item.dataset.id,
                        display: window.getComputedStyle(item).display,
                        visibility: window.getComputedStyle(item).visibility,
                        height: window.getComputedStyle(item).height,
                        overflow: window.getComputedStyle(item).overflow
                    });
                }
            }, 100);
        }
        
        // ğŸ” æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
        window.filterYarakashiList = function() {
            const searchInput = document.getElementById('yarakashi-search');
            const searchQuery = searchInput ? searchInput.value.trim() : '';
            displayYarakashiList(searchQuery);
        };
        
        // ğŸ“‹ è©³ç´°è¡¨ç¤ºãƒˆã‚°ãƒ«æ©Ÿèƒ½
        window.toggleYarakashiContent = function(itemId) {
            const fullContentElement = document.getElementById(`full-content-${itemId}`);
            const toggleTextElement = document.getElementById(`toggle-text-${itemId}`);
            
            if (!fullContentElement || !toggleTextElement) return;
            
            const isHidden = fullContentElement.style.display === 'none';
            
            if (isHidden) {
                fullContentElement.style.display = 'block';
                toggleTextElement.textContent = 'è©³ç´°éè¡¨ç¤º';
            } else {
                fullContentElement.style.display = 'none';
                toggleTextElement.textContent = 'è©³ç´°è¡¨ç¤º';
            }
        };
        
        window.resolveYarakashi = async function(id) {
            await updateYarakashiStatus(id, true);
        };
        
        window.unresolveYarakashi = async function(id) {
            await updateYarakashiStatus(id, false);
        };
        
        async function updateYarakashiStatus(id, resolved) {
            try {
                const yarakashi = yarakashiList.find(y => y.id == id);
                if (!yarakashi) return;
                
                yarakashi.resolved = resolved;
                
                if (window.firebaseTest && window.firebaseTest.getCurrentUser()) {
                    const user = window.firebaseTest.getCurrentUser();
                    const yarakashiRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/yarakashi_list/${id}`);
                    await window.firebaseTest.set(yarakashiRef, yarakashi);
                }
                
                displayYarakashiList();
                console.log(`âœ… ã‚„ã‚‰ã‹ã— ${resolved ? 'è§£æ±º' : 'æœªè§£æ±º'}:`, yarakashi.title);
                
            } catch (error) {
                console.error('âŒ ã‚„ã‚‰ã‹ã—çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error.message);
            }
        }
        
        window.deleteYarakashi = async function(id) {
            if (!confirm('ã“ã®ã‚„ã‚‰ã‹ã—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                yarakashiList = yarakashiList.filter(y => y.id != id);
                
                if (window.firebaseTest && window.firebaseTest.getCurrentUser()) {
                    const user = window.firebaseTest.getCurrentUser();
                    const yarakashiRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/yarakashi_list/${id}`);
                    await window.firebaseTest.set(yarakashiRef, null); // Firebaseã§å‰Šé™¤
                }
                
                displayYarakashiList();
                console.log('âœ… ã‚„ã‚‰ã‹ã—å‰Šé™¤å®Œäº†');
                
            } catch (error) {
                console.error('âŒ ã‚„ã‚‰ã‹ã—å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error.message);
            }
        };
        
        window.clearAllYarakashi = async function() {
            if (!confirm('å…¨ã¦ã®ã‚„ã‚‰ã‹ã—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
            
            try {
                console.log('ğŸ—‘ï¸  å…¨ã‚„ã‚‰ã‹ã—å‰Šé™¤é–‹å§‹');
                
                if (window.firebaseTest && window.firebaseTest.getCurrentUser()) {
                    const user = window.firebaseTest.getCurrentUser();
                    const yarakashiListRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/yarakashi_list`);
                }
                
                yarakashiList = [];
                window.yarakashiList = yarakashiList;
                displayYarakashiList();
                console.log('âœ… å…¨ã‚„ã‚‰ã‹ã—å‰Šé™¤å®Œäº†');
                alert('âœ… å…¨ã¦ã®ã‚„ã‚‰ã‹ã—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                
            } catch (error) {
                alert('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        };
        
        window.addSampleYarakashi = async function() {
            const samples = [
                {
                    title: 'Firebaseèªè¨¼ã§auth.emailã‚’ä½¿ç”¨ã—ã¦PERMISSION_DENIEDç™ºç”Ÿ',
                    category: 'firebase',
                    content: 'Firebase Realtime Databaseã®ãƒ«ãƒ¼ãƒ«ãŒ `$uid === auth.uid` ãªã®ã«ã€ã‚³ãƒ¼ãƒ‰ã§ `auth.email` ã‚’ä½¿ç”¨ã€‚çµæœï¼šå…¨ã¦ã®DBæ“ä½œã§PERMISSION_DENIEDã‚¨ãƒ©ãƒ¼ã€‚\n\nä¿®æ­£æ–¹æ³•ï¼š\n- `auth.email` â†’ `auth.uid` ã«å¤‰æ›´\n- ãƒ‘ã‚¹ã‚‚ `users/{uid}/` å½¢å¼ã«çµ±ä¸€'
                },
                {
                    title: 'ES6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ãŒæœªå®šç¾©',
                    category: 'ui',
                    content: '`<script type="module">` å†…ã§å®šç¾©ã—ãŸé–¢æ•°ãŒonclickå±æ€§ã‹ã‚‰å‘¼ã³å‡ºã›ãªã„ã€‚`ReferenceError: testLogin is not defined`\n\nä¿®æ­£æ–¹æ³•ï¼š\n```javascript\n// âŒ ES6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã®é–¢æ•°ã¯å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯\nfunction testLogin() { ... }\n\n// âœ… windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æ˜ç¤ºçš„ã«è¿½åŠ \nwindow.testLogin = async function() { ... };\n```'
                },
                {
                    title: 'Firebase IDã§å°æ•°ç‚¹ã‚’å«ã‚€IDã‚’ä½¿ç”¨ã—ã¦ãƒ‘ã‚¹ã‚¨ãƒ©ãƒ¼',
                    category: 'database',
                    content: '`Date.now() + Math.random()` ã§ç”Ÿæˆã—ãŸIDã«å°æ•°ç‚¹ãŒå«ã¾ã‚Œã¦Firebaseãƒ‘ã‚¹ã‚¨ãƒ©ãƒ¼ã€‚\n\nä¿®æ­£æ–¹æ³•ï¼š\n```javascript\n// âŒ å°æ•°ç‚¹å«ã‚€\nid: Date.now() + Math.random()\n\n// âœ… æ–‡å­—åˆ—ID\nid: `yarakashi_${Date.now()}_${Math.floor(Math.random() * 10000)}`\n```'
                }
            ];
            
            for (const sample of samples) {
                const yarakashi = {
                    id: `sample_${Date.now()}_${Math.floor(Math.random() * 10000)}`,
                    title: sample.title,
                    category: sample.category,
                    content: sample.content,
                    timestamp: new Date().toISOString(),
                    resolved: false
                };
                
                if (window.firebaseTest && window.firebaseTest.getCurrentUser()) {
                    const user = window.firebaseTest.getCurrentUser();
                    const yarakashiRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/yarakashi_list/${yarakashi.id}`);
                    await window.firebaseTest.set(yarakashiRef, yarakashi);
                }
                
                yarakashiList.push(yarakashi);
                
                // å°‘ã—å¾…ã¤ï¼ˆIDã®é‡è¤‡é˜²æ­¢ï¼‰
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            displayYarakashiList();
            console.log('âœ… ã‚µãƒ³ãƒ—ãƒ«ã‚„ã‚‰ã‹ã—è¿½åŠ å®Œäº†:', samples.length, 'ä»¶');
            alert(`âœ… ${samples.length}ä»¶ã®ã‚µãƒ³ãƒ—ãƒ«ã‚„ã‚‰ã‹ã—ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`);
        };
        
        // Phase1-4: ç°¡å˜ãªDBèª­ã¿æ›¸ããƒ†ã‚¹ãƒˆé–¢æ•°
        window.saveSimpleTest = async function() {
            try {
                console.log('ğŸ’¾ Firebaseä¿å­˜ãƒ†ã‚¹ãƒˆé–‹å§‹');
                const user = window.firebaseTest.getCurrentUser();
                console.log('ğŸ” èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user);
                console.log('ğŸ” Firebase UID:', user.uid);
                console.log('ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼Email:', user.email);
                
                const testData = {
                    message: "Hello Firebase!",
                    test_number: Math.floor(Math.random() * 1000),
                    phase: "Phase1-4"
                };
                
                // æ­£ã—ã„ãƒ‘ã‚¹ã§ãƒ†ã‚¹ãƒˆ
                console.log('ğŸ” ä¿å­˜å…ˆãƒ‘ã‚¹:', `users/${user.uid}/novel_ai_prompts/test_data`);
                
                await window.firebaseTest.saveTestData(testData);
                console.log('âœ… Firebaseä¿å­˜æˆåŠŸ:', testData);
                alert(`âœ… Firebaseä¿å­˜æˆåŠŸ!\nç•ªå·: ${testData.test_number}`);
                
            } catch (error) {
                console.error('âŒ Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', error.message);
                console.error('âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
                
                // ä»–ã®ãƒ‘ã‚¹ã§ãƒ†ã‚¹ãƒˆè©¦è¡Œ
                console.log('ğŸ”„ åˆ¥ãƒ‘ã‚¹ã§ãƒ†ã‚¹ãƒˆè©¦è¡Œ');
                try {
                    const { database, ref, set } = window.firebaseTest;
                    const testRef = ref(database, 'debug_test');
                    await set(testRef, { test: 'hello', time: Date.now() });
                    console.log('âœ… ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹æ›¸ãè¾¼ã¿æˆåŠŸ');
                } catch (rootError) {
                    console.error('âŒ ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã‚‚å¤±æ•—:', rootError.message);
                }
                
                alert('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message + '\nè©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèª');
            }
        };
        
        window.loadSimpleTest = async function() {
            try {
                console.log('ğŸ“– Firebaseèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆé–‹å§‹');
                const data = await window.firebaseTest.loadTestData();
                
                if (data) {
                    console.log('âœ… Firebaseèª­ã¿è¾¼ã¿æˆåŠŸ:', data);
                    alert(`âœ… Firebaseèª­ã¿è¾¼ã¿æˆåŠŸ!\n\nãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${data.message}\nç•ªå·: ${data.test_number}\nä¿å­˜æ—¥æ™‚: ${data.timestamp}`);
                } else {
                    console.log('ğŸ“­ ãƒ‡ãƒ¼ã‚¿ãªã—');
                    alert('ğŸ“­ ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“\nå…ˆã«ã€Œç°¡å˜ãƒ†ã‚¹ãƒˆä¿å­˜ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
                }
                
            } catch (error) {
                console.error('âŒ Firebaseèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error.message);
                alert('âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        };
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 5px;
        }

        .container {
            max-width: 700px;
            margin: 5px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }

        .version-badge {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 1000;
        }

        .header {
            background: linear-gradient(90deg, #4A90E2 0%, #7B68EE 100%);
            color: white;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.6rem;
            margin: 0;
        }

        .controls {
            background: #f8f9fa;
            padding: 8px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .unified-prompt-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .prompt-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .prompt-row:last-child {
            margin-bottom: 0;
        }

        .prompt-field {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            flex: 1;
        }

        .prompt-field h3 {
            min-width: 80px;
            margin: 0;
            padding-top: 8px;
            font-size: 0.9rem;
            color: #333;
        }

        .unified-prompt {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .unified-prompt.main-prompt {
            min-height: 120px;
        }

        .unified-prompt:focus {
            outline: none;
            border-color: #4A90E2;
        }

        .title-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .title-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            transition: border-color 0.3s;
        }

        .title-input:focus {
            outline: none;
            border-color: #4A90E2;
        }


        .input-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .input-section h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        textarea::placeholder {
            color: #f0f0f0;
            opacity: 0.3;
        }

        input::placeholder {
            color: #f0f0f0;
            opacity: 0.3;
        }

        .input-with-label {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .input-with-label h3 {
            margin: 0;
            min-width: 120px;
            padding-top: 8px;
            font-size: 0.9rem;
        }

        .input-with-label textarea {
            flex: 1;
        }

        .copy-btn-side {
            padding: 8px 12px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 40px;
            height: 40px;
            margin-top: 2px;
        }

        .copy-btn-side:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .save-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .save-and-clear-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .save-buttons {
            display: flex;
            gap: 15px;
            flex: 1;
        }

        .btn-save {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            min-width: 150px;
            flex: 1;
            max-width: 200px;
        }

        .btn-clear {
            padding: 12px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
        }

        .btn-clear:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .title-input-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .title-input-row h3 {
            margin: 0;
            min-width: 140px;
            font-size: 1rem;
        }

        .title-input-row .title-input {
            flex: 1;
        }

        .potion-preview {
            background: #f8f9fa;
            border: 2px dashed #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-top: 10px;
            min-height: 120px;
        }

        .potion-preview-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .potion-preview-img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border: 3px solid #28a745;
            flex-shrink: 0;
        }

        .potion-preview-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 120px;
            justify-content: center;
        }

        .potion-preview-info span {
            font-weight: bold;
            color: #28a745;
            font-size: 16px;
            word-break: break-word;
        }

        .btn-remove-potion {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            align-self: flex-start;
            transition: all 0.3s;
        }

        .btn-remove-potion:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .debug-panel {
            background: white;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid #17a2b8;
        }

        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #17a2b8;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .debug-header h4 {
            margin: 0;
            font-size: 1rem;
        }

        .debug-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-copy-logs, .btn-clear-logs {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-copy-logs {
            background: #28a745;
            color: white;
        }

        .btn-copy-logs:hover {
            background: #218838;
        }

        .btn-clear-logs {
            background: #dc3545;
            color: white;
        }

        .btn-clear-logs:hover {
            background: #c82333;
        }

        .debug-logs {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            background: #f8f9fa;
            color: #333;
        }

        .debug-log-entry {
            margin-bottom: 8px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .debug-log-info {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        .debug-log-success {
            background: #e8f5e8;
            border-left: 3px solid #4caf50;
        }

        .debug-log-error {
            background: #ffebee;
            border-left: 3px solid #f44336;
        }

        .debug-log-warn {
            background: #fff3e0;
            border-left: 3px solid #ff9800;
        }

        .btn-large {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            min-width: 200px;
        }

        .search-input-group {
            display: flex;
            gap: 8px;
        }

        .search-input-group .search-input {
            flex: 1;
        }

        .btn-search {
            padding: 8px 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            min-width: 40px;
        }

        .btn-search:hover {
            background: #0056b3;
        }

        .btn-search-clear {
            padding: 8px 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            min-width: 40px;
        }

        .btn-search-clear:hover {
            background: #c82333;
        }

        .search-within-save {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .search-within-save h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1rem;
        }

        .search-inline {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-input-group-compact {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-input-compact {
            width: 200px;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .stats-compact {
            text-align: center;
            padding: 10px 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            color: #666;
        }

        .stats-compact span {
            font-weight: bold;
            color: #4A90E2;
        }

        .search-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 20px;
        }

        .search-keyword-tag {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            animation: fadeInScale 0.3s ease;
        }

        .search-keyword-tag .remove-keyword {
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            padding: 0 2px;
            margin-left: 2px;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .search-keyword-tag .remove-keyword:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .exclude-keyword-tag {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            animation: fadeInScale 0.3s ease;
        }

        .exclude-keyword-tag .remove-keyword {
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            padding: 0 2px;
            margin-left: 2px;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .exclude-keyword-tag .remove-keyword:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .tags-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tags-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tag-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .tag-input:focus {
            outline: none;
            border-color: #4A90E2;
        }

        .add-tag-btn {
            padding: 8px 16px;
            background: linear-gradient(45deg, #17a2b8, #6f42c1);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .existing-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tag-item {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #bbdefb;
        }

        .tag-item:hover {
            background: #1976d2;
            color: white;
        }

        .tag-item.selected {
            background: #4A90E2;
            color: white;
            border-color: #4A90E2;
        }

        .current-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .current-tag {
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .remove-tag {
            cursor: pointer;
            font-weight: bold;
        }

        .search-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .search-section h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1rem;
        }

        .search-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .potion-input-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .potion-input-section h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1rem;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4A90E2, #7B68EE);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #6f42c1);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .main-content {
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 8px 15px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .stat-item {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4A90E2;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .prompt-list {
            display: grid;
            gap: 8px;
        }

        .prompt-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px 15px;
            transition: all 0.2s;
        }

        .prompt-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        .prompt-content-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .prompt-image-main {
            flex-shrink: 0;
        }

        .prompt-main-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .prompt-info {
            flex: 1;
        }

        .prompt-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .prompt-thumbnail {
            display: flex;
            align-items: center;
        }

        .thumbnail-image {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid #28a745;
            cursor: pointer;
            transition: all 0.3s;
        }

        .thumbnail-image:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .prompt-meta {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .mini-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 4px;
        }

        .mini-tag.potion-name {
            background: #e8f5e8;
            color: #2e7d32;
            font-weight: bold;
        }

        .prompt-title-line {
            font-size: 13px;
            color: #333;
            line-height: 1.3;
        }

        .btn-delete {
            padding: 6px 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .btn-delete:hover {
            background: #c82333;
            transform: scale(1.05);
        }


        .prompt-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4A90E2;
            line-height: 1.6;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-size: 13px;
        }

        .character-content {
            border-left-color: #28a745;
        }


        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 80px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .search-highlight {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .file-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .prompt-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .search-highlight {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
        }


        @media (max-width: 768px) {
            .prompt-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .prompt-field h3 {
                min-width: auto;
                padding-top: 0;
            }
        }

        @media (max-width: 768px) {
            .search-filter-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .save-and-clear-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .save-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn-save {
                max-width: none;
            }
            
            .btn-clear {
                align-self: stretch;
            }
            
            .title-input-row {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .title-input-row h3 {
                min-width: auto;
                text-align: center;
            }
            
            .potion-preview-content {
                flex-direction: column;
                text-align: center;
            }
            
            .potion-preview-img {
                width: 100px;
                height: 100px;
            }
            
            .potion-preview-info {
                min-height: auto;
            }
            
            .prompt-main-image {
                width: 40px;
                height: 40px;
            }
            
            .thumbnail-image {
                width: 24px;
                height: 24px;
            }
            
            .button-group {
                justify-content: center;
            }
            
            .stats {
                flex-direction: column;
                align-items: center;
            }
            
            .version-badge {
                top: 10px;
                right: 15px;
                font-size: 0.75rem;
                padding: 4px 8px;
            }
        }

        /* ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨CSS */
        .tab-menu {
            display: flex;
            gap: 5px;
            background: rgba(255,255,255,0.1);
            padding: 5px;
            border-radius: 8px;
        }

        .tab-button {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .tab-button.active {
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        /* åˆæœŸçŠ¶æ…‹ã§ã‚„ã‚‰ã‹ã—ã‚¿ãƒ–ã‚’è¡¨ç¤º */
        #yarakashi-tab {
            display: block !important;
        }
        
        /* ã‚„ã‚‰ã‹ã—ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹ */
        .tab-button[data-tab="yarakashi"] {
            background: #4CAF50;
            color: white;
        }

        /* ã‚„ã‚‰ã‹ã—ãƒªã‚¹ãƒˆå°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .yarakashi-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #f44336;
        }

        .yarakashi-item.resolved {
            border-left-color: #4CAF50;
        }

        .yarakashi-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .yarakashi-meta {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .yarakashi-content {
            line-height: 1.5;
            color: #555;
        }
        
        /* ã‚µã‚¤ã‚ºè¡¨ç¤ºãƒãƒƒã‚¸ */
        .size-display {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ (600px-900pxå¹…ã€900px-1200pxé«˜ã•) */
        @media screen and (min-width: 600px) and (max-width: 900px) and (min-height: 900px) and (max-height: 1200px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 20px;
                margin: 10px 0;
            }
            
            .tab-button {
                padding: 6px 12px;
                font-size: 12px;
                margin: 2px;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            textarea {
                font-size: 12px;
                padding: 8px;
            }
            
            button {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            input[type="text"], input[type="email"] {
                font-size: 12px;
                padding: 6px;
            }
            
            .yarakashi-item, .issue-item {
                padding: 10px;
                margin: 8px 0;
            }
            
            .yarakashi-title, .issue-title {
                font-size: 14px;
            }
            
            .yarakashi-content, .issue-content {
                font-size: 12px;
                line-height: 1.4;
            }
            
            /* ã‚µã‚¤ã‚ºè¡¨ç¤ºã‚’ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã«èª¿æ•´ */
            .size-display {
                font-size: 11px;
                padding: 6px 8px;
                top: 5px;
                left: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="size-display" id="size-display">æ¸¬å®šä¸­...</div>
        <div class="version-badge">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div class="header">
            <h1>ğŸ“‹ çµ±åˆç®¡ç†ã‚¢ãƒ—ãƒª</h1>
            
            <!-- èªè¨¼ã‚¨ãƒªã‚¢ï¼ˆå³å¯„ã›ï¼‰ -->
            <div style="display: flex; align-items: center; gap: 8px;">
                <span id="auth-status" style="font-size: 13px; font-weight: bold;">ğŸ” èªè¨¼ä¸­...</span>
                <button id="login-btn" onclick="testLogin()" style="background: #4CAF50; color: white; padding: 4px 10px; border: none; border-radius: 4px; font-size: 12px; display: none;">
                    ğŸ” ãƒ­ã‚°ã‚¤ãƒ³
                </button>
                <button id="logout-btn" onclick="testLogout()" style="background: #f44336; color: white; padding: 4px 10px; border: none; border-radius: 4px; font-size: 12px; display: none;">
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </div>
        
        <!-- ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å¤–ï¼‰ -->
        <div class="tab-menu" style="margin-top: 0px; background: #f8f9fa; padding: 5px 15px; border-bottom: 1px solid #e9ecef;">
                <button class="tab-button active" data-tab="yarakashi" onclick="switchTab('yarakashi')">
                    ğŸš¨ ã‚„ã‚‰ã‹ã—ãƒªã‚¹ãƒˆ
                </button>
                <button class="tab-button" data-tab="issues" onclick="switchTab('issues')">
                    ğŸ“‹ èª²é¡Œãƒªã‚¹ãƒˆ
                </button>
                <button class="tab-button" data-tab="novel-ai" onclick="switchTab('novel-ai')">
                    ğŸ¨ Novel AI
                </button>
                <button class="tab-button" data-tab="claude-code" onclick="switchTab('claude-code')">
                    ğŸ’» Claude Code
                </button>
        </div>

        <!-- ã‚„ã‚‰ã‹ã—ãƒªã‚¹ãƒˆã‚¿ãƒ– -->
        <div id="yarakashi-tab" class="tab-content active">
            <!-- ğŸš¨ ã‚„ã‚‰ã‹ã—å…¥åŠ›ãƒ‘ãƒãƒ« -->
            <div class="major-panel" style="border: 5px solid #f44336; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: #fff8f8; box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);">
                <h3 style="margin: 0 0 15px 0; color: #f44336; font-size: 1.2rem; font-weight: bold;">ğŸš¨ ã‚„ã‚‰ã‹ã—å…¥åŠ›ã‚¨ãƒªã‚¢</h3>
                
                <div class="yarakashi-section">
                    <div style="background: white; padding: 8px 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 8px;">
                        <h4>æ–°ã—ã„ã‚„ã‚‰ã‹ã—ã‚’è¿½åŠ </h4>
                    <div style="margin-bottom: 15px;">
                        <label for="yarakashi-title" style="display: block; font-weight: 600; margin-bottom: 5px;">ã‚¿ã‚¤ãƒˆãƒ«:</label>
                        <input type="text" id="yarakashi-title" placeholder="ã‚„ã‚‰ã‹ã—ã®æ¦‚è¦ã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="yarakashi-category" style="display: block; font-weight: 600; margin-bottom: 5px;">ã‚«ãƒ†ã‚´ãƒª:</label>
                        <select id="yarakashi-category" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="firebase">Firebase</option>
                            <option value="auth">èªè¨¼</option>
                            <option value="ui">UI/UX</option>
                            <option value="database">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</option>
                            <option value="other">ãã®ä»–</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="yarakashi-content" style="display: block; font-weight: 600; margin-bottom: 5px;">è©³ç´°å†…å®¹:</label>
                        <textarea id="yarakashi-content" rows="4" placeholder="ã‚„ã‚‰ã‹ã—ã®è©³ç´°ã€åŸå› ã€è§£æ±ºæ–¹æ³•ã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="addYarakashi()" style="background: #f44336; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; flex: 1;">
                            ğŸš¨ ã‚„ã‚‰ã‹ã—è¿½åŠ 
                        </button>
                        <button onclick="addSampleYarakashi()" style="background: #2196F3; color: white; padding: 12px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                            ğŸ“ ã‚µãƒ³ãƒ—ãƒ«
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ” ã‚„ã‚‰ã‹ã—æ¤œç´¢ãƒ‘ãƒãƒ« -->
            <div class="major-panel" style="border: 5px solid #FF9800; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: #fff9f0; box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);">
                <h3 style="margin: 0 0 15px 0; color: #FF9800; font-size: 1.2rem; font-weight: bold;">ğŸ” ã‚„ã‚‰ã‹ã—æ¤œç´¢ã‚¨ãƒªã‚¢</h3>
                
                <!-- ğŸ” ã‚„ã‚‰ã‹ã—æ¤œç´¢æ©Ÿèƒ½ -->
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="yarakashi-search" placeholder="ğŸ” ã‚„ã‚‰ã‹ã—ã‚’æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»å†…å®¹ãƒ»ã‚«ãƒ†ã‚´ãƒªï¼‰" 
                               style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                               oninput="filterYarakashiList()" onkeypress="if(event.key==='Enter') filterYarakashiList()">
                        <button onclick="filterYarakashiList()" style="background: #7B68EE; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer;">ğŸ” æ¤œç´¢</button>
                        <button onclick="clearYarakashiSearch()" style="background: #666; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer;">ã‚¯ãƒªã‚¢</button>
                    </div>
                    <div style="margin-top: 5px; font-size: 12px; color: #666;">
                        <span id="yarakashi-search-result">å…¨ <span id="total-count">0</span> ä»¶</span>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ“‹ ã‚„ã‚‰ã‹ã—ãƒªã‚¹ãƒˆè¡¨ç¤ºãƒ‘ãƒãƒ« -->
            <div class="major-panel" style="border: 5px solid #C62828; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: #fff5f5; box-shadow: 0 4px 8px rgba(198, 40, 40, 0.3);">
                <h3 style="margin: 0 0 15px 0; color: #C62828; font-size: 1.2rem; font-weight: bold;">ğŸ“‹ ã‚„ã‚‰ã‹ã—ãƒªã‚¹ãƒˆè¡¨ç¤º</h3>

                <div id="yarakashi-list" style="max-height: none; overflow: visible;">
                    <!-- ã‚„ã‚‰ã‹ã—ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>

        <!-- ğŸ“‹ èª²é¡Œãƒªã‚¹ãƒˆã‚¿ãƒ– -->
        <div id="issues-tab" class="tab-content">
            <!-- ğŸ“‹ èª²é¡Œå…¥åŠ›ãƒ‘ãƒãƒ« -->
            <div class="major-panel" style="border: 5px solid #2196F3; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: #f8fbff; box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);">
                <h3 style="margin: 0 0 15px 0; color: #2196F3; font-size: 1.2rem; font-weight: bold;">ğŸ“‹ èª²é¡Œå…¥åŠ›ã‚¨ãƒªã‚¢</h3>
                
                <div class="issues-section">
                    <div style="background: white; padding: 8px 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 8px;">
                        <h4>æ–°ã—ã„èª²é¡Œã‚’è¿½åŠ </h4>
                    <div style="margin-bottom: 15px;">
                        <label for="issue-title" style="display: block; font-weight: 600; margin-bottom: 5px;">ã‚¿ã‚¤ãƒˆãƒ«:</label>
                        <input type="text" id="issue-title" placeholder="èª²é¡Œã®æ¦‚è¦ã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="issue-priority" style="display: block; font-weight: 600; margin-bottom: 5px;">å„ªå…ˆåº¦:</label>
                        <select id="issue-priority" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="high">ğŸ”¥ é«˜</option>
                            <option value="medium">ğŸ“‹ ä¸­</option>
                            <option value="low">ğŸ’¤ ä½</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="issue-project" style="display: block; font-weight: 600; margin-bottom: 5px;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</label>
                        <select id="issue-project" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="novel-ai">ğŸ¨ Novel AI Manager</option>
                            <option value="yarakashi">ğŸš¨ ã‚„ã‚‰ã‹ã—ç®¡ç†</option>
                            <option value="claude-code">ğŸ’» Claude Code</option>
                            <option value="other">ğŸ”§ ãã®ä»–</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="issue-content" style="display: block; font-weight: 600; margin-bottom: 5px;">è©³ç´°:</label>
                        <textarea id="issue-content" placeholder="èª²é¡Œã®è©³ç´°ã€è§£æ±ºæ–¹æ³•ã®ææ¡ˆãªã©" rows="5" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                    </div>
                    <div style="text-align: center;">
                        <button onclick="addIssue()" style="background: #2196F3; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            ğŸ“‹ èª²é¡Œã‚’è¿½åŠ 
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ” èª²é¡Œæ¤œç´¢ãƒ‘ãƒãƒ« -->
            <div class="major-panel" style="border: 5px solid #03A9F4; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: #f0faff; box-shadow: 0 4px 8px rgba(3, 169, 244, 0.3);">
                <h3 style="margin: 0 0 15px 0; color: #03A9F4; font-size: 1.2rem; font-weight: bold;">ğŸ” èª²é¡Œæ¤œç´¢ã‚¨ãƒªã‚¢</h3>
                
                <!-- ğŸ” èª²é¡Œæ¤œç´¢æ©Ÿèƒ½ -->
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="issue-search" placeholder="ğŸ” èª²é¡Œã‚’æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»å†…å®¹ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰" 
                               style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                               oninput="filterIssueList()" onkeypress="if(event.key==='Enter') filterIssueList()">
                        <button onclick="filterIssueList()" style="background: #7B68EE; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer;">ğŸ” æ¤œç´¢</button>
                        <button onclick="clearIssueSearch()" style="background: #666; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer;">ã‚¯ãƒªã‚¢</button>
                    </div>
                    <div style="margin-top: 5px; font-size: 12px; color: #666;">
                        <span id="issue-search-result">å…¨ <span id="issue-total-count">0</span> ä»¶</span>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ“‹ èª²é¡Œãƒªã‚¹ãƒˆè¡¨ç¤ºãƒ‘ãƒãƒ« -->
            <div class="major-panel" style="border: 5px solid #3F51B5; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: #f6f7ff; box-shadow: 0 4px 8px rgba(63, 81, 181, 0.3);">
                <h3 style="margin: 0 0 15px 0; color: #3F51B5; font-size: 1.2rem; font-weight: bold;">ğŸ“‹ èª²é¡Œãƒªã‚¹ãƒˆè¡¨ç¤º</h3>

                <div id="issue-list" style="max-height: none; overflow: visible;">
                    <!-- èª²é¡Œãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>

        <!-- Novel AIã‚¿ãƒ–ï¼ˆæ—¢å­˜æ©Ÿèƒ½ï¼‰ -->
        <div id="novel-ai-tab" class="tab-content">
            <!-- ğŸ¯ å…¥åŠ›æ¬„ãƒ‘ãƒãƒ« -->
            <div class="major-panel" style="border: 5px solid #4A90E2; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: #f8f9ff; box-shadow: 0 4px 8px rgba(74, 144, 226, 0.3);">
                <h3 style="margin: 0 0 15px 0; color: #4A90E2; font-size: 1.2rem; font-weight: bold;">ğŸ¯ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢</h3>
                
                <div class="controls">
                    <!-- ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                    <div class="title-section">
                <div class="title-input-row" style="display: flex; gap: 15px; align-items: center; width: 100%;">
                    <div style="display: flex; align-items: center; gap: 10px; flex: 2;">
                        <label style="min-width: 140px; font-weight: 600; font-size: 1rem;">ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¿ã‚¤ãƒˆãƒ«:</label>
                        <input type="text" id="promptTitle" class="title-input" placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: æ£®ã®ä¸­ã®ç¾å°‘å¥³ã€æˆ¦é—˜ã‚·ãƒ¼ãƒ³ãªã©ï¼‰" maxlength="50" style="flex: 1;">
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                        <label style="min-width: 80px; font-weight: 600; font-size: 1rem;">ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒª:</label>
                        <select id="promptCategory" class="title-input" style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="character">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</option>
                            <option value="background">èƒŒæ™¯</option>
                            <option value="scene">ã‚·ãƒ¼ãƒ³</option>
                            <option value="style">ã‚¹ã‚¿ã‚¤ãƒ«</option>
                            <option value="other">ãã®ä»–</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="input-section unified-prompt-section">
                <div class="prompt-row">
                    <div class="prompt-field">
                        <h3>ğŸŒŸ ãƒ¡ã‚¤ãƒ³</h3>
                        <textarea id="mainPrompt" class="unified-prompt main-prompt" placeholder="èƒŒæ™¯ã€è¨­å®šã€å“è³ªæŒ‡å®šãªã©..."></textarea>
                        <button onclick="copyIndividualPrompt('main')" class="copy-btn-side">ğŸ“‹</button>
                    </div>
                </div>
                <div class="prompt-row">
                    <div class="prompt-field">
                        <h3>ğŸ‘¤ 1äººç›®</h3>
                        <textarea id="character1" class="unified-prompt" placeholder="1äººç›®ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°..."></textarea>
                        <button onclick="copyIndividualPrompt('char1')" class="copy-btn-side">ğŸ“‹</button>
                    </div>
                </div>
                <div class="prompt-row">
                    <div class="prompt-field">
                        <h3>ğŸ‘¥ 2äººç›®</h3>
                        <textarea id="character2" class="unified-prompt" placeholder="2äººç›®ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°..."></textarea>
                        <button onclick="copyIndividualPrompt('char2')" class="copy-btn-side">ğŸ“‹</button>
                    </div>
                </div>
                <div class="prompt-row">
                    <div class="prompt-field">
                        <h3>ğŸ‘¥+ 3ã€œ6äººç›®</h3>
                        <textarea id="character3to6" class="unified-prompt" placeholder="3ã€œ6äººç›®ã®è¿½åŠ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼..."></textarea>
                        <button onclick="copyIndividualPrompt('char3to6')" class="copy-btn-side">ğŸ“‹</button>
                    </div>
                </div>
            </div>

            <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜ãƒ»æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="save-section">
                <div class="save-and-clear-section">
                    <div class="save-buttons">
                        <button onclick="savePrompt('new')" class="btn-primary btn-save">ğŸ’¾ æ–°è¦ä¿å­˜</button>
                        <button onclick="savePrompt('overwrite')" class="btn-secondary btn-save" id="overwriteBtn" style="display: none;">ğŸ“ ä¸Šæ›¸ãä¿å­˜</button>
                        <button onclick="saveFromClipboard()" class="btn-secondary btn-save">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ä¿å­˜</button>
                    </div>
                    <button onclick="clearAllInputs()" class="btn-clear">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
                </div>
                
                <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒœã‚¿ãƒ³ãƒ‘ãƒãƒ« -->
                <div class="sample-panel" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e9ecef;">
                    <h4 style="margin: 0 0 10px 0; color: #495057; font-size: 14px;">ğŸ¯ ã‚¯ã‚¤ãƒƒã‚¯ã‚µãƒ³ãƒ—ãƒ«</h4>
                    <button onclick="loadSamplePrompt()" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s;" onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">
                        ğŸ“ ã‚µãƒ³ãƒ—ãƒ«
                    </button>
                </div>
            </div>

            <!-- ğŸ” æ¤œç´¢æ¬„ãƒ‘ãƒãƒ« -->
            <div class="major-panel" style="border: 5px solid #28a745; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: #f8fff8; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);">
                <h3 style="margin: 0 0 15px 0; color: #28a745; font-size: 1.2rem; font-weight: bold;">ğŸ” æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚¨ãƒªã‚¢</h3>
                
                <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ -->
                <div class="search-within-save">
                    <div class="search-inline">
                        <h4>æ¤œç´¢</h4>
                        <div class="search-input-group-compact">
                            <input type="text" id="searchInput" class="search-input-compact" placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ã§æ¤œç´¢...">
                            <button onclick="addSearchKeyword()" class="btn-search">â•</button>
                            <button onclick="clearAllSearchKeywords()" class="btn-search-clear">âŒ</button>
                        </div>
                    </div>
                    <div class="search-keywords" id="searchKeywords">
                        <!-- æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¿ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                    
                    <div class="search-inline" style="margin-top: 10px;">
                        <h4>é™¤å¤–</h4>
                        <div class="search-input-group-compact">
                            <input type="text" id="excludeInput" class="search-input-compact" placeholder="é™¤å¤–ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰...">
                            <button onclick="addExcludeKeyword()" class="btn-search">â–</button>
                            <button onclick="clearAllExcludeKeywords()" class="btn-search-clear">âŒ</button>
                        </div>
                    </div>
                    
                    <div class="search-keywords" id="excludeKeywords">
                        <!-- é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¿ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>
                
                <div id="potionPreview" class="potion-preview" style="display: none;">
                    <div class="potion-preview-content">
                        <img id="potionPreviewImage" src="" alt="ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”»åƒ" class="potion-preview-img">
                        <div class="potion-preview-info">
                            <span id="potionPreviewName">ãƒãƒ¼ã‚·ãƒ§ãƒ³å</span>
                            <button onclick="removePotionData()" class="btn-remove-potion">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- ã‚¿ã‚°ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="tags-section">
                <div class="input-with-label">
                    <h3>ğŸ·ï¸ ã‚¿ã‚°ç®¡ç†</h3>
                    <input type="text" id="tagInput" class="tag-input" placeholder="æ–°ã—ã„ã‚¿ã‚°ã‚’å…¥åŠ›... (ä¾‹: ç”·æ€§, å¥³æ€§, æ£®ã®ä¸­, å¤œ)">
                    <button onclick="addTag()" class="add-tag-btn">â• ã‚¿ã‚°è¿½åŠ </button>
                </div>
                
                <div class="existing-tags" id="existingTags">
                    <!-- æ—¢å­˜ã‚¿ã‚°ãŒå‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
                
                <div class="current-tags" id="currentTags">
                    <!-- ç¾åœ¨é¸æŠä¸­ã®ã‚¿ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
            </div>

            <!-- ğŸ“‹ å€¤ã®ãƒªã‚¹ãƒˆãƒ‘ãƒãƒ« -->
            <div class="major-panel" style="border: 5px solid #dc3545; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: #fff8f8; box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);">
                <h3 style="margin: 0 0 15px 0; color: #dc3545; font-size: 1.2rem; font-weight: bold;">ğŸ“‹ ä¿å­˜æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¸€è¦§</h3>
                
                <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="main-content">
                    <!-- çµ±è¨ˆè¡¨ç¤º -->
                    <div class="stats-compact">
                        ç·ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ <span id="totalCount">0</span> | æ¤œç´¢çµæœ <span id="searchCount">0</span> | ä»Šæ—¥è¿½åŠ  <span id="todayCount">0</span> | ã‚¿ã‚°æ•° <span id="tagCount">0</span>
                    </div>

                    <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¸€è¦§ -->
                    <div id="promptList" class="prompt-list">
                        <div class="empty-state">
                            <h3>ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</h3>
                            <p>æœ€åˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒãƒ¼ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="potion-input-section">
                <h4>ğŸ§ª ãƒãƒ¼ã‚·ãƒ§ãƒ³</h4>
                <input type="file" id="potionInput" class="file-input" accept=".txt,.json,.png,.jpg,.jpeg" multiple onchange="loadPotions()">
            </div>

            <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
            <div class="button-group">
                <button onclick="exportData()" class="btn-info">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button onclick="importData()" class="btn-info">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <button onclick="toggleDebugPanel()" class="btn-info">ğŸ” ãƒ‡ãƒãƒƒã‚°</button>
            </div>

            <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
            <div id="debugPanel" class="debug-panel" style="display: none;">
                <div class="debug-header">
                    <h4>ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h4>
                    <div class="debug-buttons">
                        <button onclick="copyDebugLogs()" class="btn-copy-logs">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                        <button onclick="clearDebugLogs()" class="btn-clear-logs">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                    </div>
                </div>
                <div id="debugLogs" class="debug-logs"></div>
            </div>
        </div>
    </div>

    <script>
        let prompts = [];
        let allTags = new Set();
        let currentTags = new Set();
        let currentSearch = '';
        let searchKeywords = new Set(); // è¤‡æ•°æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        let excludeKeywords = new Set(); // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        let currentEditingId = null; // ç¾åœ¨ç·¨é›†ä¸­ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆID
        let debugLogs = []; // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ä¿å­˜ç”¨

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.onload = async function() {
            await loadPrompts();
            displayPrompts();
            updateStats();
            updateTagsDisplay();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            document.getElementById('tagInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTag();
                }
            });
            
            // æ¤œç´¢ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addSearchKeyword();
                }
            });
            
            // é™¤å¤–å…¥åŠ›ã®Enterã‚­ãƒ¼å¯¾å¿œ
            document.getElementById('excludeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addExcludeKeyword();
                }
            });
        };

        // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¿½åŠ 
        function addSearchKeyword() {
            const input = document.getElementById('searchInput');
            const keyword = input.value.trim();
            
            if (!keyword) return;
            
            searchKeywords.add(keyword);
            input.value = '';
            updateSearchKeywordsDisplay();
            displayPrompts();
            showNotification(`æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œ${keyword}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
        }

        // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å‰Šé™¤
        function removeSearchKeyword(keyword) {
            searchKeywords.delete(keyword);
            updateSearchKeywordsDisplay();
            displayPrompts();
            showNotification(`æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œ${keyword}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }

        // å…¨æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒªã‚¢
        function clearAllSearchKeywords() {
            searchKeywords.clear();
            document.getElementById('searchInput').value = '';
            updateSearchKeywordsDisplay();
            displayPrompts();
            showNotification('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }

        // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºæ›´æ–°
        function updateSearchKeywordsDisplay() {
            const container = document.getElementById('searchKeywords');
            container.innerHTML = Array.from(searchKeywords).map(keyword => 
                `<span class="search-keyword-tag">
                    ${keyword}
                    <span class="remove-keyword" onclick="removeSearchKeyword('${keyword}')">Ã—</span>
                </span>`
            ).join('');
        }

        // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¿½åŠ 
        function addExcludeKeyword() {
            const input = document.getElementById('excludeInput');
            const keyword = input.value.trim();
            
            if (!keyword) return;
            
            excludeKeywords.add(keyword);
            input.value = '';
            updateExcludeKeywordsDisplay();
            displayPrompts();
            showNotification(`é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œ${keyword}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
        }

        // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å‰Šé™¤
        function removeExcludeKeyword(keyword) {
            excludeKeywords.delete(keyword);
            updateExcludeKeywordsDisplay();
            displayPrompts();
            showNotification(`é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œ${keyword}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }

        // å…¨é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒªã‚¢
        function clearAllExcludeKeywords() {
            excludeKeywords.clear();
            document.getElementById('excludeInput').value = '';
            updateExcludeKeywordsDisplay();
            displayPrompts();
            showNotification('é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }

        // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºæ›´æ–°
        function updateExcludeKeywordsDisplay() {
            const container = document.getElementById('excludeKeywords');
            container.innerHTML = Array.from(excludeKeywords).map(keyword => 
                `<span class="exclude-keyword-tag">
                    ${keyword}
                    <span class="remove-keyword" onclick="removeExcludeKeyword('${keyword}')">Ã—</span>
                </span>`
            ).join('');
        }

        // å€‹åˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã‚³ãƒ”ãƒ¼
        async function copyIndividualPrompt(type) {
            let content = '';
            
            switch(type) {
                case 'main':
                    content = document.getElementById('mainPrompt').value.trim();
                    break;
                case 'char1':
                    content = document.getElementById('character1').value.trim();
                    break;
                case 'char2':
                    content = document.getElementById('character2').value.trim();
                    break;
                case 'char3to6':
                    content = document.getElementById('character3to6').value.trim();
                    break;
            }
            
            if (!content) {
                alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(content);
                showNotification(`${getPromptTypeName(type)}ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼`);
            } catch (err) {
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function getPromptTypeName(type) {
            const names = {
                'main': 'ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ',
                'char1': '1äººç›®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼',
                'char2': '2äººç›®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼',
                'char3to6': '3ã€œ6äººç›®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼'
            };
            return names[type] || type;
        }

        // ã‚¿ã‚°ã®è¿½åŠ 
        function addTag() {
            const input = document.getElementById('tagInput');
            const tagName = input.value.trim();
            
            if (!tagName) return;
            
            currentTags.add(tagName);
            allTags.add(tagName);
            
            input.value = '';
            updateTagsDisplay();
        }

        // ã‚¿ã‚°è¡¨ç¤ºã®æ›´æ–°
        function updateTagsDisplay() {
            // æ—¢å­˜ã‚¿ã‚°ä¸€è¦§ã®æ›´æ–°
            const existingTagsContainer = document.getElementById('existingTags');
            existingTagsContainer.innerHTML = Array.from(allTags).map(tag => 
                `<span class="tag-item ${currentTags.has(tag) ? 'selected' : ''}" onclick="toggleTag('${tag}')">${tag}</span>`
            ).join('');
            
            // ç¾åœ¨é¸æŠä¸­ã‚¿ã‚°ã®æ›´æ–°
            const currentTagsContainer = document.getElementById('currentTags');
            currentTagsContainer.innerHTML = Array.from(currentTags).map(tag => 
                `<span class="current-tag">${tag} <span class="remove-tag" onclick="removeCurrentTag('${tag}')">Ã—</span></span>`
            ).join('');
            
        }

        // ã‚¿ã‚°ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleTag(tagName) {
            if (currentTags.has(tagName)) {
                currentTags.delete(tagName);
            } else {
                currentTags.add(tagName);
            }
            updateTagsDisplay();
        }

        // ç¾åœ¨ã®ã‚¿ã‚°ã‚’å‰Šé™¤
        function removeCurrentTag(tagName) {
            currentTags.delete(tagName);
            updateTagsDisplay();
        }

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿å­˜
        async function savePrompt(mode = 'new') {
            debugLog(`=== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜é–‹å§‹ ===`, 'info');
            debugLog(`ä¿å­˜ãƒ¢ãƒ¼ãƒ‰: ${mode}`, 'info');
            
            const title = document.getElementById('promptTitle').value.trim();
            const mainPrompt = document.getElementById('mainPrompt').value.trim();
            
            debugLog(`ã‚¿ã‚¤ãƒˆãƒ«: "${title}"`, 'info');
            debugLog(`ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "${mainPrompt.substring(0, 50)}..."`, 'info');
            
            if (!title) {
                debugLog('ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã®ãŸã‚ä¿å­˜ä¸­æ­¢', 'error');
                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!mainPrompt) {
                debugLog('ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç©ºã®ãŸã‚ä¿å­˜ä¸­æ­¢', 'error');
                alert('ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const promptData = {
                title: title,
                mainPrompt: mainPrompt,
                character1: document.getElementById('character1').value.trim(),
                character2: document.getElementById('character2').value.trim(),
                character3to6: document.getElementById('character3to6').value.trim(),
                tags: Array.from(currentTags),
                timestamp: new Date(),
                source: window.currentPotionData ? 'potion' : 'manual'
            };

            // ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
            if (window.currentPotionData) {
                promptData.image = window.currentPotionData.image;
                promptData.imageName = window.currentPotionData.imageName;
                promptData.potionName = window.currentPotionData.potionName;
                // ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ã‚°ã‚’è¿½åŠ 
                if (!promptData.tags.includes('ãƒãƒ¼ã‚·ãƒ§ãƒ³')) {
                    promptData.tags.push('ãƒãƒ¼ã‚·ãƒ§ãƒ³');
                    currentTags.add('ãƒãƒ¼ã‚·ãƒ§ãƒ³');
                }
            }

            if (mode === 'overwrite' && currentEditingId) {
                // ä¸Šæ›¸ãä¿å­˜
                const index = prompts.findIndex(p => p.id == currentEditingId);
                if (index !== -1) {
                    promptData.id = currentEditingId;
                    promptData.originalTimestamp = prompts[index].timestamp; // å…ƒã®ä½œæˆæ—¥æ™‚ã‚’ä¿æŒ
                    prompts[index] = promptData;
                    showNotification('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¸Šæ›¸ãä¿å­˜ã—ã¾ã—ãŸï¼');
                } else {
                    // å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æ–°è¦ä¿å­˜
                    promptData.id = Date.now();
                    prompts.unshift(promptData);
                    showNotification('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ–°è¦ä¿å­˜ã—ã¾ã—ãŸï¼');
                }
            } else {
                // æ–°è¦ä¿å­˜
                promptData.id = Date.now();
                prompts.unshift(promptData);
                showNotification('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ–°è¦ä¿å­˜ã—ã¾ã—ãŸï¼');
            }
            
            // ã‚¿ã‚°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ãƒƒãƒˆã«è¿½åŠ 
            currentTags.forEach(tag => allTags.add(tag));
            debugLog(`ã‚¿ã‚°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ãƒƒãƒˆã«è¿½åŠ : [${Array.from(currentTags).join(', ')}]`, 'info');
            
            debugLog('savePrompts()å‘¼ã³å‡ºã—å‰ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ•°: ' + prompts.length, 'info');
            await savePrompts();
            debugLog('savePrompts()å‘¼ã³å‡ºã—å¾Œã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ•°: ' + prompts.length, 'info');
            
            clearInputs();
            displayPrompts();
            updateStats();
            updateTagsDisplay();
            updateSaveButtons();
            
            debugLog('=== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜å®Œäº† ===', 'success');
        }

        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¯ãƒªã‚¢
        function clearInputs() {
            document.getElementById('promptTitle').value = '';
            document.getElementById('mainPrompt').value = '';
            document.getElementById('character1').value = '';
            document.getElementById('character2').value = '';
            document.getElementById('character3to6').value = '';
            currentTags.clear();
            // ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã‚‚ã‚¯ãƒªã‚¢
            window.currentPotionData = null;
            currentEditingId = null;
            updatePotionPreview();
            updateSaveButtons();
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®èª­ã¿è¾¼ã¿
        function loadSamplePrompt() {
            debugLog('=== ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹ ===', 'info');
            
            // ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚µãƒ³ãƒ—ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
            document.getElementById('promptTitle').value = 'æ£®ã®ä¸­ã®ç¾å°‘å¥³';
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚µãƒ³ãƒ—ãƒ«ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¨­å®š
            document.getElementById('promptCategory').value = 'character';
            
            // ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨­å®š
            document.getElementById('mainPrompt').value = 'beautiful anime girl in forest, detailed face, masterpiece, high quality, soft lighting, nature background, peaceful atmosphere';
            
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼1ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
            document.getElementById('character1').value = 'long brown hair, green eyes, white dress, gentle smile, standing pose, looking at viewer';
            
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼2ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
            document.getElementById('character2').value = 'short blonde hair, blue eyes, red jacket, cheerful expression, sitting on tree stump';
            
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼3-6ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
            document.getElementById('character3to6').value = 'fairy companion: small wings, glowing aura, magical sparkles\nforest animals: rabbits, birds, deer in background\nfloral elements: colorful flowers, vines, cherry blossoms\nsunlight filtering through trees, magical atmosphere';
            
            // ã‚µãƒ³ãƒ—ãƒ«ç”¨ã®ã‚¿ã‚°ã‚’è¨­å®š
            currentTags.clear();
            currentTags.add('ã‚µãƒ³ãƒ—ãƒ«');
            currentTags.add('æ£®');
            currentTags.add('ç¾å°‘å¥³');
            currentTags.add('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼');
            
            // ã‚¿ã‚°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ãƒƒãƒˆã«è¿½åŠ 
            currentTags.forEach(tag => allTags.add(tag));
            
            // UIæ›´æ–°
            updateTagsDisplay();
            
            // ç·¨é›†ä¸­IDã‚’ã‚¯ãƒªã‚¢ï¼ˆæ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ï¼‰
            currentEditingId = null;
            updateSaveButtons();
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            showNotification('ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼âœ¨');
            
            debugLog('ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†', 'success');
        }

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ä¿å­˜
        async function saveFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                if (!text.trim()) {
                    alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒç©ºã§ã™');
                    return;
                }

                const prompt = {
                    id: Date.now(),
                    title: text.trim().substring(0, 30) + (text.length > 30 ? '...' : ''),
                    mainPrompt: text.trim(),
                    character1: '',
                    character2: '',
                    character3to6: '',
                    tags: Array.from(currentTags),
                    timestamp: new Date(),
                    source: 'clipboard'
                };

                prompts.unshift(prompt);
                
                currentTags.forEach(tag => allTags.add(tag));
                
                savePrompts();
                displayPrompts();
                updateStats();
                
                showNotification('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            } catch (err) {
                alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¡¨ç¤º
        function displayPrompts() {
            const container = document.getElementById('promptList');
            const filteredPrompts = filterPrompts();

            if (filteredPrompts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸ” ${currentSearch ? 'æ¤œç´¢çµæœãªã—' : 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Šã¾ã›ã‚“'}</h3>
                        <p>${currentSearch ? 'æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' : 'æœ€åˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„'}</p>
                    </div>
                `;
                updateStats();
                return;
            }

            container.innerHTML = filteredPrompts.map(prompt => `
                <div class="prompt-item">
                    <div class="prompt-content-row">
                        ${prompt.image ? `<div class="prompt-image-main"><img src="${prompt.image}" alt="${prompt.imageName || 'ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”»åƒ'}" class="prompt-main-image"></div>` : ''}
                        <div class="prompt-info" onclick="restorePromptToInputs('${prompt.id}')" style="cursor: pointer;">
                            <div class="prompt-meta">
                                ğŸ“… ${formatDateTime(prompt.timestamp)} 
                                ${prompt.source === 'clipboard' ? 'ğŸ“‹' : prompt.source === 'file' ? 'ğŸ“' : prompt.source === 'potion' ? 'ğŸ§ª' : 'âœï¸'}
                                ${prompt.tags.map(tag => `<span class="mini-tag">${tag}</span>`).join('')}
                                ${prompt.potionName ? `<span class="mini-tag potion-name">ğŸ§ª ${prompt.potionName}</span>` : ''}
                            </div>
                            <div class="prompt-title-line">
                                <strong>${highlightSearchKeywords(prompt.title || 'ç„¡é¡Œ')}</strong> - ${highlightSearchKeywords(truncateText(prompt.mainPrompt, 50))}
                            </div>
                        </div>
                        <div class="prompt-actions">
                            ${prompt.image ? `<div class="prompt-thumbnail"><img src="${prompt.image}" alt="${prompt.imageName || 'ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”»åƒ'}" class="thumbnail-image" title="${prompt.potionName || prompt.imageName || 'ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”»åƒ'}"></div>` : ''}
                            <button onclick="deletePrompt('${prompt.id}')" class="btn-delete">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            `).join('');

            updateStats();
        }

        // ä¿å­˜æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã‚³ãƒ”ãƒ¼
        async function copyStoredPrompt(id, type) {
            const prompt = prompts.find(p => p.id == id);
            if (!prompt) return;

            let content = '';
            switch(type) {
                case 'main':
                    content = prompt.mainPrompt;
                    break;
                case 'char1':
                    content = prompt.character1;
                    break;
                case 'char2':
                    content = prompt.character2;
                    break;
                case 'char3to6':
                    content = prompt.character3to6;
                    break;
            }

            if (!content.trim()) {
                alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            try {
                await navigator.clipboard.writeText(content);
                showNotification(`${getPromptTypeName(type)}ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼`);
            } catch (err) {
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterPrompts() {
            let filtered = prompts;

            // è¤‡æ•°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆANDæ¤œç´¢ï¼‰
            if (searchKeywords.size > 0) {
                const keywords = Array.from(searchKeywords).map(k => k.toLowerCase());
                debugLog(`è¤‡æ•°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢å®Ÿè¡Œ: [${keywords.join(', ')}] - å¯¾è±¡ä»¶æ•°: ${prompts.length}`, 'info');
                
                filtered = filtered.filter(prompt => {
                    // å…¨ã¦ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒãƒƒãƒã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆANDæ¤œç´¢ï¼‰
                    return keywords.every(searchTerm => {
                        const titleMatch = prompt.title && prompt.title.toLowerCase().includes(searchTerm);
                        const mainMatch = prompt.mainPrompt && prompt.mainPrompt.toLowerCase().includes(searchTerm);
                        const char1Match = prompt.character1 && prompt.character1.toLowerCase().includes(searchTerm);
                        const char2Match = prompt.character2 && prompt.character2.toLowerCase().includes(searchTerm);
                        const char3Match = prompt.character3to6 && prompt.character3to6.toLowerCase().includes(searchTerm);
                        const tagMatch = prompt.tags && prompt.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                        
                        return titleMatch || mainMatch || char1Match || char2Match || char3Match || tagMatch;
                    });
                });
                
                debugLog(`è¤‡æ•°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµæœ: ${filtered.length}ä»¶`, 'success');
            }

            // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã„ãšã‚Œã‹ãŒå«ã¾ã‚Œã‚‹ã‚‚ã®ã‚’é™¤å¤–ï¼‰
            if (excludeKeywords.size > 0) {
                const excludeTerms = Array.from(excludeKeywords).map(k => k.toLowerCase());
                debugLog(`é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å®Ÿè¡Œ: [${excludeTerms.join(', ')}] - å¯¾è±¡ä»¶æ•°: ${filtered.length}`, 'info');
                
                const beforeCount = filtered.length;
                filtered = filtered.filter(prompt => {
                    // ã„ãšã‚Œã‹ã®é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯é™¤å¤–
                    return !excludeTerms.some(excludeTerm => {
                        const titleMatch = prompt.title && prompt.title.toLowerCase().includes(excludeTerm);
                        const mainMatch = prompt.mainPrompt && prompt.mainPrompt.toLowerCase().includes(excludeTerm);
                        const char1Match = prompt.character1 && prompt.character1.toLowerCase().includes(excludeTerm);
                        const char2Match = prompt.character2 && prompt.character2.toLowerCase().includes(excludeTerm);
                        const char3Match = prompt.character3to6 && prompt.character3to6.toLowerCase().includes(excludeTerm);
                        const tagMatch = prompt.tags && prompt.tags.some(tag => tag.toLowerCase().includes(excludeTerm));
                        
                        return titleMatch || mainMatch || char1Match || char2Match || char3Match || tagMatch;
                    });
                });
                
                debugLog(`é™¤å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµæœ: ${filtered.length}ä»¶ (${beforeCount - filtered.length}ä»¶é™¤å¤–)`, 'success');
            }

            return filtered;
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã®åˆ‡ã‚Šè©°ã‚
        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›æ¬„ã«å¾©å…ƒ
        function restorePromptToInputs(id) {
            debugLog(`=== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¾©å…ƒé–‹å§‹ ===`, 'info');
            debugLog(`å¯¾è±¡ID: ${id}`, 'info');
            
            const prompt = prompts.find(p => p.id == id);
            if (!prompt) {
                debugLog(`ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ID=${id}`, 'error');
                return;
            }
            
            debugLog(`è¦‹ã¤ã‹ã£ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "${prompt.title}"`, 'success');
            
            // å„å…¥åŠ›æ¬„ã«å€¤ã‚’è¨­å®š
            document.getElementById('promptTitle').value = prompt.title || '';
            document.getElementById('mainPrompt').value = prompt.mainPrompt || '';
            document.getElementById('character1').value = prompt.character1 || '';
            document.getElementById('character2').value = prompt.character2 || '';
            document.getElementById('character3to6').value = prompt.character3to6 || '';
            
            debugLog(`å…¥åŠ›æ¬„ã«å€¤ã‚’è¨­å®šå®Œäº†`, 'success');
            
            // ã‚¿ã‚°ã‚‚å¾©å…ƒ
            currentTags.clear();
            if (prompt.tags) {
                prompt.tags.forEach(tag => currentTags.add(tag));
            }
            updateTagsDisplay();
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
            currentEditingId = id;
            
            // ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯ä¸€æ™‚ä¿å­˜
            if (prompt.source === 'potion' || prompt.image) {
                window.currentPotionData = {
                    image: prompt.image,
                    imageName: prompt.imageName,
                    potionName: prompt.potionName
                };
            } else {
                window.currentPotionData = null;
            }
            
            // UIæ›´æ–°
            updatePotionPreview();
            updateSaveButtons();
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            showNotification(`"${prompt.title || 'ç„¡é¡Œ'}" ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§å¾©å…ƒã—ã¾ã—ãŸï¼${prompt.source === 'potion' ? ' ğŸ§ª' : ''}`);
            
            // å…¥åŠ›ã‚¨ãƒªã‚¢ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.querySelector('.title-section').scrollIntoView({ behavior: 'smooth' });
        }

        // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆè¤‡æ•°å¯¾å¿œï¼‰
        function highlightSearchKeywords(content) {
            if (searchKeywords.size === 0 || !content) {
                return content || '';
            }

            let highlightedContent = content;
            
            // å„æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            Array.from(searchKeywords).forEach(keyword => {
                const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                highlightedContent = highlightedContent.replace(regex, '<span class="search-highlight">$1</span>');
            });
            
            return highlightedContent;
        }

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å‰Šé™¤
        function deletePrompt(id) {
            if (!confirm('ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            prompts = prompts.filter(p => p.id != id);
            savePrompts();
            displayPrompts();
            updateStats();
            
            showNotification('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // çµ±è¨ˆã®æ›´æ–°
        function updateStats() {
            const total = prompts.length;
            const filtered = filterPrompts().length;
            const today = prompts.filter(p => {
                const promptDate = new Date(p.timestamp);
                const todayDate = new Date();
                return promptDate.toDateString() === todayDate.toDateString();
            }).length;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('searchCount').textContent = filtered;
            document.getElementById('todayCount').textContent = today;
            document.getElementById('tagCount').textContent = allTags.size;
        }

        // ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿
        function loadPotions() {
            const potionInput = document.getElementById('potionInput');
            const files = potionInput.files;

            debugLog('=== ãƒãƒ¼ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿é–‹å§‹ ===', 'info');
            debugLog('é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°: ' + files.length, 'info');

            if (files.length === 0) {
                debugLog('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                alert('ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            let loadedCount = 0;
            const totalFiles = files.length; // ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’äº‹å‰ã«ä¿å­˜
            const potionData = {};

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                const fileExt = file.name.split('.').pop().toLowerCase();
                
                debugLog('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†é–‹å§‹: ' + file.name + ' (ã‚¿ã‚¤ãƒ—: ' + fileExt + ')', 'info');
                
                if (['png', 'jpg', 'jpeg'].includes(fileExt)) {
                    // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                    debugLog('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦èª­ã¿è¾¼ã¿: ' + file.name, 'info');
                    reader.onload = function(e) {
                        const baseName = file.name.replace(/\.(png|jpg|jpeg)$/i, '');
                        if (!potionData[baseName]) {
                            potionData[baseName] = {};
                        }
                        potionData[baseName].image = e.target.result;
                        potionData[baseName].imageName = file.name;
                        
                        debugLog('ç”»åƒãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ' + baseName, 'success');
                        debugLog('ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: ' + Math.round(e.target.result.length / 1024) + 'KB', 'info');
                        
                        loadedCount++;
                        debugLog('èª­ã¿è¾¼ã¿å®Œäº†ã‚«ã‚¦ãƒ³ãƒˆ: ' + loadedCount + '/' + totalFiles, 'info');
                        if (loadedCount === totalFiles) {
                            debugLog('å…¨ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ã€processPotionDataå‘¼ã³å‡ºã—', 'info');
                            processPotionData(potionData);
                        }
                    };
                    reader.readAsDataURL(file);
                } else if (['txt', 'json'].includes(fileExt)) {
                    // ãƒ†ã‚­ã‚¹ãƒˆ/JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                    debugLog('ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦èª­ã¿è¾¼ã¿: ' + file.name, 'info');
                    reader.onload = function(e) {
                        const baseName = file.name.replace(/\.(txt|json)$/i, '');
                        if (!potionData[baseName]) {
                            potionData[baseName] = {};
                        }
                        
                        let content;
                        if (fileExt === 'json') {
                            try {
                                const jsonData = JSON.parse(e.target.result);
                                content = jsonData.prompt || jsonData.text || JSON.stringify(jsonData, null, 2);
                                debugLog('JSONè§£ææˆåŠŸ: ' + baseName, 'success');
                            } catch (err) {
                                content = e.target.result;
                                debugLog('JSONè§£æå¤±æ•—ã€ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å‡¦ç†: ' + baseName, 'warn');
                            }
                        } else {
                            content = e.target.result;
                        }
                        
                        potionData[baseName].content = content.trim();
                        potionData[baseName].textName = file.name;
                        
                        debugLog('ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ' + baseName, 'success');
                        debugLog('ãƒ†ã‚­ã‚¹ãƒˆæ–‡å­—æ•°: ' + content.trim().length + 'æ–‡å­—', 'info');
                        
                        loadedCount++;
                        if (loadedCount === totalFiles) {
                            processPotionData(potionData);
                        }
                    };
                    reader.readAsText(file, 'UTF-8');
                } else {
                    debugLog('ã‚µãƒãƒ¼ãƒˆå¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: ' + file.name, 'error');
                    alert(`${file.name} ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™`);
                    loadedCount++;
                    if (loadedCount === totalFiles) {
                        processPotionData(potionData);
                    }
                }
            });

            potionInput.value = '';
        }

        // ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
        function processPotionData(potionData) {
            debugLog('=== ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿å‡¦ç†é–‹å§‹ ===', 'info');
            debugLog('å‡¦ç†å¯¾è±¡ãƒãƒ¼ã‚·ãƒ§ãƒ³æ•°: ' + Object.keys(potionData).length, 'info');
            
            let processedCount = 0;
            
            Object.keys(potionData).forEach(baseName => {
                const potion = potionData[baseName];
                debugLog('ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ä¸­: ' + baseName, 'info');
                debugLog('- ãƒ†ã‚­ã‚¹ãƒˆ: ' + (potion.content ? 'ã‚ã‚Š' : 'ãªã—'), 'info');
                debugLog('- ç”»åƒ: ' + (potion.image ? 'ã‚ã‚Š' : 'ãªã—'), 'info');
                
                // ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã—ã¦ä¿å­˜
                if (potion.content) {
                    const prompt = {
                        id: Date.now() + Math.random(),
                        title: baseName || (potion.content.substring(0, 30) + '...'),
                        mainPrompt: potion.content,
                        character1: '',
                        character2: '',
                        character3to6: '',
                        tags: ['ãƒãƒ¼ã‚·ãƒ§ãƒ³'],
                        timestamp: new Date(),
                        source: 'potion',
                        potionName: baseName,
                        image: potion.image,
                        imageName: potion.imageName,
                        textName: potion.textName
                    };

                    prompts.unshift(prompt);
                    processedCount++;
                    debugLog('ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã—ã¦è¿½åŠ : ' + baseName, 'success');
                }
                
                // ç”»åƒã®ã¿ã®å ´åˆã¯å…¥åŠ›æ¬„ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                if (potion.image && !potion.content) {
                    debugLog('ç”»åƒã®ã¿ã®ãƒãƒ¼ã‚·ãƒ§ãƒ³æ¤œå‡º: ' + baseName, 'info');
                    window.currentPotionData = {
                        image: potion.image,
                        imageName: potion.imageName,
                        potionName: baseName
                    };
                    debugLog('currentPotionDataè¨­å®šå®Œäº†', 'success');
                    debugLog('ç”»åƒãƒ‡ãƒ¼ã‚¿å…ˆé ­ç¢ºèª: ' + potion.image.substring(0, 30) + '...', 'info');
                    updatePotionPreview();
                    debugLog('updatePotionPreviewå‘¼ã³å‡ºã—å®Œäº†', 'success');
                }
            });
            
            debugLog('å‡¦ç†å®Œäº†æ•°: ' + processedCount, 'info');
            
            if (processedCount > 0) {
                // ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ã‚°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¿ã‚°ã«è¿½åŠ 
                allTags.add('ãƒãƒ¼ã‚·ãƒ§ãƒ³');
                
                // æœ€åˆã®ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¥åŠ›æ¬„ã«è‡ªå‹•è¨­å®šã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                if (processedCount === 1) {
                    debugLog('å˜ä¸€ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¥åŠ›æ¬„ã«è‡ªå‹•è¨­å®š', 'info');
                    const firstPotionName = Object.keys(potionData)[0];
                    const firstPotion = potionData[firstPotionName];
                    
                    document.getElementById('promptTitle').value = firstPotionName;
                    document.getElementById('mainPrompt').value = firstPotion.content;
                    
                    if (firstPotion.image) {
                        window.currentPotionData = {
                            image: firstPotion.image,
                            imageName: firstPotion.imageName,
                            potionName: firstPotionName
                        };
                        debugLog('è‡ªå‹•è¨­å®šã•ã‚ŒãŸãƒãƒ¼ã‚·ãƒ§ãƒ³: ' + firstPotionName, 'success');
                        updatePotionPreview();
                    }
                }
                
                savePrompts();
                displayPrompts();
                updateStats();
                updateTagsDisplay();
                showNotification(`${processedCount}å€‹ã®ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ğŸ§ª`);
                debugLog('ãƒãƒ¼ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿æˆåŠŸ: ' + processedCount + 'å€‹', 'success');
            } else {
                showNotification('èª­ã¿è¾¼ã¿å¯èƒ½ãªãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                debugLog('èª­ã¿è¾¼ã¿å¯èƒ½ãªãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„', 'warn');
            }
            
            debugLog('=== ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿å‡¦ç†çµ‚äº† ===', 'info');
        }

        // ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°
        function updatePotionPreview() {
            const preview = document.getElementById('potionPreview');
            const previewImage = document.getElementById('potionPreviewImage');
            const previewName = document.getElementById('potionPreviewName');
            
            debugLog('=== updatePotionPreview é–‹å§‹ ===', 'info');
            debugLog('currentPotionData: ' + (window.currentPotionData ? 'ã‚ã‚Š' : 'ãªã—'), 'info');
            debugLog('previewè¦ç´ : ' + (preview ? 'OK' : 'NG'), 'info');
            debugLog('previewImageè¦ç´ : ' + (previewImage ? 'OK' : 'NG'), 'info');
            
            if (window.currentPotionData && window.currentPotionData.image) {
                const imageData = window.currentPotionData.image;
                debugLog('ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚ã‚Š', 'info');
                debugLog('ç”»åƒãƒ‡ãƒ¼ã‚¿å…ˆé ­: ' + imageData.substring(0, 50) + '...', 'info');
                debugLog('ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—: ' + (imageData.startsWith('data:') ? 'base64' : 'ãã®ä»–'), 'info');
                
                // å¼·åˆ¶çš„ã«ç”»åƒã‚’è¡¨ç¤º
                previewImage.src = imageData;
                previewImage.style.display = 'block';
                previewImage.style.visibility = 'visible';
                previewImage.style.opacity = '1';
                
                previewName.textContent = window.currentPotionData.potionName || window.currentPotionData.imageName || 'ãƒãƒ¼ã‚·ãƒ§ãƒ³';
                preview.style.display = 'block';
                
                debugLog('ç”»åƒsrcè¨­å®šå®Œäº†', 'success');
                
                // ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸæ™‚
                previewImage.onload = function() {
                    debugLog('âœ… ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸï¼ ã‚µã‚¤ã‚º: ' + this.naturalWidth + 'x' + this.naturalHeight, 'success');
                };
                
                // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                previewImage.onerror = function() {
                    debugLog('âŒ ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—', 'error');
                    debugLog('ç”»åƒãƒ‡ãƒ¼ã‚¿: ' + imageData.substring(0, 100) + '...', 'error');
                    previewName.textContent = 'ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ - ' + (window.currentPotionData.imageName || 'unknown');
                };
                
                // å³åº§ã«çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
                setTimeout(() => {
                    debugLog('1ç§’å¾Œã®ãƒã‚§ãƒƒã‚¯:', 'info');
                    debugLog('- complete: ' + previewImage.complete, 'info');
                    debugLog('- naturalWidth: ' + previewImage.naturalWidth, 'info');
                    debugLog('- display: ' + previewImage.style.display, 'info');
                }, 1000);
                
            } else {
                debugLog('âŒ ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ãªã—ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤º', 'warn');
                preview.style.display = 'none';
            }
            
            debugLog('=== updatePotionPreview çµ‚äº† ===', 'info');
        }

        // ä¿å­˜ãƒœã‚¿ãƒ³ã®æ›´æ–°
        function updateSaveButtons() {
            const overwriteBtn = document.getElementById('overwriteBtn');
            
            if (currentEditingId) {
                overwriteBtn.style.display = 'block';
            } else {
                overwriteBtn.style.display = 'none';
            }
        }

        // ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
        function removePotionData() {
            window.currentPotionData = null;
            updatePotionPreview();
            showNotification('ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // å…¨å…¥åŠ›å†…å®¹ã®ã‚¯ãƒªã‚¢
        function clearAllInputs() {
            clearInputs();
            updateTagsDisplay();
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°é–¢æ•°
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                time: timestamp,
                message: message,
                type: type
            };
            debugLogs.push(logEntry);
            
            // ãƒ­ã‚°ãŒå¤šã™ãã‚‹å ´åˆã¯å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
            if (debugLogs.length > 100) {
                debugLogs = debugLogs.slice(-50);
            }
            
            updateDebugDisplay();
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                debugLog('ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ã‚’é–‹ãã¾ã—ãŸ', 'info');
            } else {
                panel.style.display = 'none';
            }
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®è¡¨ç¤ºæ›´æ–°
        function updateDebugDisplay() {
            const logsContainer = document.getElementById('debugLogs');
            if (!logsContainer) return;
            
            logsContainer.innerHTML = debugLogs.map(log => 
                `<div class="debug-log-entry debug-log-${log.type}">
                    <strong>[${log.time}]</strong> ${log.message}
                </div>`
            ).join('');
            
            // æœ€æ–°ã®ãƒ­ã‚°ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®ã‚³ãƒ”ãƒ¼
        async function copyDebugLogs() {
            const logText = debugLogs.map(log => 
                `[${log.time}] ${log.type.toUpperCase()}: ${log.message}`
            ).join('\n');
            
            try {
                await navigator.clipboard.writeText(logText);
                debugLog('ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
            } catch (err) {
                debugLog('ãƒ­ã‚°ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
            }
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®ã‚¯ãƒªã‚¢
        function clearDebugLogs() {
            debugLogs = [];
            updateDebugDisplay();
            debugLog('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            if (prompts.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const exportData = {
                prompts: prompts,
                tags: Array.from(allTags),
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `novel_ai_prompts_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼');
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (importedData.prompts && Array.isArray(importedData.prompts)) {
                            prompts = [...importedData.prompts, ...prompts];
                            
                            if (importedData.tags && Array.isArray(importedData.tags)) {
                                importedData.tags.forEach(tag => allTags.add(tag));
                            }
                            
                            savePrompts();
                            displayPrompts();
                            updateStats();
                            updateTagsDisplay();
                            showNotification(`${importedData.prompts.length}å€‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼`);
                        } else {
                            alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
                        }
                    } catch (err) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
        function clearAll() {
            if (!confirm('å…¨ã¦ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
            
            prompts = [];
            allTags.clear();
            currentTags.clear();
            savePrompts();
            displayPrompts();
            updateStats();
            updateTagsDisplay();
            showNotification('å…¨ã¦ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ï¼ˆlocalStorage + Firebaseçµ±åˆï¼‰
        async function savePrompts() {
            const saveData = {
                prompts: prompts,
                tags: Array.from(allTags)
            };
            debugLog(`çµ±åˆä¿å­˜å®Ÿè¡Œ: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ${prompts.length}ä»¶ã€ã‚¿ã‚°${allTags.size}å€‹`, 'info');
            
            // 1. localStorageä¿å­˜ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
            try {
                localStorage.setItem('novel_ai_prompts', JSON.stringify(saveData));
                debugLog('localStorageä¿å­˜æˆåŠŸ', 'success');
            } catch (err) {
                debugLog('localStorageä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
            }
            
            // 2. Firebaseä¿å­˜ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰
            try {
                if (window.firebaseTest && window.firebaseTest.getCurrentUser()) {
                    const user = window.firebaseTest.getCurrentUser();
                    
                    // å„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å€‹åˆ¥ã«ä¿å­˜
                    for (const prompt of prompts) {
                        const promptRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/novel_ai_prompts/${prompt.id}`);
                        await window.firebaseTest.set(promptRef, prompt);
                    }
                    
                    debugLog('Firebaseä¿å­˜æˆåŠŸ: ' + prompts.length + 'ä»¶', 'success');
                } else {
                    debugLog('âš ï¸ Firebaseæœªæ¥ç¶šã¾ãŸã¯æœªãƒ­ã‚°ã‚¤ãƒ³ - Firebaseä¿å­˜ã‚¹ã‚­ãƒƒãƒ—', 'info');
                }
            } catch (error) {
                debugLog('Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                console.error('âŒ Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', error.message);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆlocalStorageï¼‰
        // Novel AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿ï¼ˆlocalStorage + Firebaseçµ±åˆï¼‰
        async function loadPrompts() {
            debugLog('=== Novel AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹ ===', 'info');
            
            // 1. localStorageèª­ã¿è¾¼ã¿
            let localPrompts = [];
            const saved = localStorage.getItem('novel_ai_prompts');
            if (saved) {
                debugLog('localStorage ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹', 'info');
                try {
                    const data = JSON.parse(saved);
                    if (data.prompts) {
                        localPrompts = data.prompts;
                        debugLog(`localStorage ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿: ${localPrompts.length}ä»¶`, 'success');
                    }
                    if (data.tags) {
                        allTags = new Set(data.tags);
                    }
                } catch (err) {
                    console.error('localStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                    debugLog('localStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
                }
            }
            
            // 2. Firebaseèª­ã¿è¾¼ã¿
            let firebasePrompts = [];
            try {
                if (window.firebaseTest && window.firebaseTest.getCurrentUser()) {
                    const user = window.firebaseTest.getCurrentUser();
                    const promptsRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/novel_ai_prompts`);
                    const snapshot = await window.firebaseTest.get(promptsRef);
                    
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        firebasePrompts = Object.values(data).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        debugLog(`Firebase ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿: ${firebasePrompts.length}ä»¶`, 'success');
                    } else {
                        debugLog('Firebase ã«ãƒ‡ãƒ¼ã‚¿ãªã—', 'info');
                    }
                } else {
                    debugLog('âš ï¸ Firebaseæœªæ¥ç¶šã¾ãŸã¯æœªãƒ­ã‚°ã‚¤ãƒ³ - Novel AIèª­ã¿è¾¼ã¿ã‚¹ã‚­ãƒƒãƒ—', 'info');
                }
            } catch (error) {
                console.error('âŒ Firebaseèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error.message);
                debugLog('Firebaseèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
            
            // 3. ãƒ‡ãƒ¼ã‚¿çµ±åˆï¼ˆFirebaseå„ªå…ˆã€localStorageã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
            if (firebasePrompts.length > 0) {
                prompts = firebasePrompts;
                debugLog('Firebase ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨', 'info');
            } else if (localPrompts.length > 0) {
                prompts = localPrompts;
                debugLog('localStorage ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼ˆFirebaseç§»è¡ŒãŒå¿…è¦ï¼‰', 'warn');
                
                // ğŸ”„ åˆå›ç§»è¡Œ: localStorageãƒ‡ãƒ¼ã‚¿ã‚’Firebaseã«ç§»è¡Œ
                if (window.firebaseTest && window.firebaseTest.getCurrentUser()) {
                    debugLog('localStorage â†’ Firebase ç§»è¡Œé–‹å§‹', 'info');
                    try {
                        const user = window.firebaseTest.getCurrentUser();
                        for (const prompt of localPrompts) {
                            const promptRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/novel_ai_prompts/${prompt.id}`);
                            await window.firebaseTest.set(promptRef, prompt);
                        }
                        debugLog(`Firebaseç§»è¡Œå®Œäº†: ${localPrompts.length}ä»¶`, 'success');
                    } catch (error) {
                        debugLog('Firebaseç§»è¡Œã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                    }
                }
            } else {
                prompts = [];
                debugLog('ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆFirebaseãƒ»localStorageå…±ã«ç©ºï¼‰', 'info');
            }
            
            // 4. ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æ­£è¦åŒ–
            prompts.forEach(prompt => {
                if (typeof prompt.timestamp === 'string') {
                    prompt.timestamp = new Date(prompt.timestamp);
                }
                // å¤ã„ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ã®äº’æ›æ€§
                if (!prompt.character1) {
                    prompt.character1 = '';
                    prompt.character2 = '';
                    prompt.character3to6 = '';
                    prompt.mainPrompt = prompt.content || '';
                }
                if (!prompt.tags) {
                    prompt.tags = [];
                }
                // ã‚¿ã‚¤ãƒˆãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ ï¼ˆV0.21ä»¥é™ï¼‰
                if (!prompt.title) {
                    prompt.title = prompt.mainPrompt ? 
                        truncateText(prompt.mainPrompt, 30) : 'ç„¡é¡Œ';
                }
            });
            
            debugLog(`=== Novel AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†: ${prompts.length}ä»¶ ===`, 'success');
            debugLog(`ãƒ‡ãƒ¼ã‚¿çµ±åˆçµæœ: Firebase=${firebasePrompts.length}ä»¶, localStorage=${localPrompts.length}ä»¶`, 'info');
            console.log('ğŸ” NOVEL AI DEBUG:', {
                firebaseCount: firebasePrompts.length,
                localStorageCount: localPrompts.length,
                finalCount: prompts.length,
                user: window.firebaseTest?.getCurrentUser()?.email
            });
        }

        // æ—¥æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDateTime(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hour = String(d.getHours()).padStart(2, '0');
            const minute = String(d.getMinutes()).padStart(2, '0');
            return `${year}/${month}/${day} ${hour}:${minute}`;
        }

        // é€šçŸ¥ã®è¡¨ç¤º
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨CSSï¼ˆå‹•çš„ã«è¿½åŠ ï¼‰
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        
        // å‰Šé™¤æ¸ˆã¿ - çµ±ä¸€åˆæœŸåŒ–å‡¦ç†ã«é›†ç´„
    </script>
    
    <!-- æ—§åˆæœŸåŒ–å‡¦ç†å‰Šé™¤æ¸ˆã¿ - v0.98çµ±åˆç‰ˆ -->
    <script>
        // æ—§åˆæœŸåŒ–å‡¦ç†ã¯ä¸Šéƒ¨ã®DOMContentLoadedã«çµ±åˆæ¸ˆã¿
        // é‡è¤‡å‰Šé™¤å®Œäº†
    </script>
    
    <!-- å„æ©Ÿèƒ½ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        // å¤ã„ã‚³ãƒ¼ãƒ‰å‰Šé™¤æ¸ˆã¿ - å„æ©Ÿèƒ½ã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹
    </script>
    
    <!-- æ©Ÿèƒ½åˆ¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼šèª²é¡Œãƒªã‚¹ãƒˆç®¡ç† -->
    <script>
        // ğŸ“‹ èª²é¡Œãƒªã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½
        // å¤ã„ã‚³ãƒ¼ãƒ‰å‰Šé™¤ - æ­£å¸¸ãªéƒ¨åˆ†ã¾ã§å¾…æ©Ÿ
    </script>
    
    <!-- æ­£å¸¸ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆéƒ¨åˆ†é–‹å§‹ -->
    <script>
        // èª²é¡Œãƒªã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½ã¯ä¸‹éƒ¨ã«ç§»å‹•æ¸ˆã¿
    </script>
    
    <!-- èª²é¡Œãƒªã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½ -->
    <script>
        // å¤ã„ã‚³ãƒ¼ãƒ‰æ–­ç‰‡å‰Šé™¤å®Œäº† - æ­£å¸¸ãªèª²é¡Œãƒªã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½ã¯ä¸‹éƒ¨ã«ç§»å‹•æ¸ˆã¿
    </script>
    
    <script>
        // å‰Šé™¤å®Œäº† - æ­£å¸¸ãªèª²é¡Œãƒªã‚¹ãƒˆæ©Ÿèƒ½ã¯ä»¥ä¸‹ã«å­˜åœ¨
    </script>
    
    <script>
        // ğŸ“‹ èª²é¡Œãƒªã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½ (æ­£å¸¸ç‰ˆ)
        let issuesList = [];
        window.issuesList = issuesList;
        
        console.log('âœ… èª²é¡Œãƒªã‚¹ãƒˆåˆæœŸåŒ–å®Œäº†');
    </script>
    
    <script>
                console.log('âœ… Claude Codeã‚¿ãƒ–è¿½åŠ å®Œäº†');
            }
            
            // Step2: ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã®åˆæœŸåŒ–ã¨å¾©å…ƒ
            setTimeout(() => {
                const savedTab = localStorage.getItem('currentTab') || 'yarakashi';
                console.log(`ğŸ”„ ã‚¿ãƒ–çŠ¶æ…‹å¾©å…ƒ: ${savedTab}`);
                
                // å…¨ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç¢ºèª
                const tabButtons = document.querySelectorAll('.tab-button');
                const tabContents = document.querySelectorAll('.tab-content');
                
                console.log(`ğŸ” ã‚¿ãƒ–ãƒœã‚¿ãƒ³æ•°: ${tabButtons.length}, ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ•°: ${tabContents.length}`);
                
                if (tabButtons.length > 0 && tabContents.length > 0) {
                    window.switchTab(savedTab);
                    console.log('âœ… ã‚¿ãƒ–å¾©å…ƒå®Œäº†');
                } else {
                    console.error('âŒ ã‚¿ãƒ–è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            }, 200);
            
            console.log('ğŸš€ çµ±åˆç®¡ç†ã‚¢ãƒ—ãƒªåˆæœŸåŒ–å®Œäº†ï¼ˆv0.95ï¼‰');
        });
        
        // ğŸ“‹ èª²é¡Œãƒªã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½
        let issuesList = [];
        window.issuesList = issuesList;
        
        window.addIssue = async function() {
            try {
                const title = document.getElementById('issue-title').value.trim();
                const priority = document.getElementById('issue-priority').value;
                const project = document.getElementById('issue-project').value;
                const content = document.getElementById('issue-content').value.trim();
                
                if (!title || !content) {
                    alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                const issue = {
                    id: `issue_${Date.now()}_${Math.floor(Math.random() * 10000)}`,
                    title: title,
                    priority: priority,
                    project: project,
                    content: content,
                    status: 'open',
                    timestamp: new Date().toISOString()
                };
                
                if (window.firebaseTest && window.firebaseTest.getCurrentUser()) {
                    const user = window.firebaseTest.getCurrentUser();
                    const issueRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/issues_list/${issue.id}`);
                    await window.firebaseTest.set(issueRef, issue);
                }
                
                issuesList.push(issue);
                displayIssuesList();
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
                document.getElementById('issue-title').value = '';
                document.getElementById('issue-content').value = '';
                
                console.log('âœ… èª²é¡Œè¿½åŠ å®Œäº†:', issue.title);
                
            } catch (error) {
                console.error('âŒ èª²é¡Œè¿½åŠ ã‚¨ãƒ©ãƒ¼:', error.message);
                alert('âŒ èª²é¡Œè¿½åŠ ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        };
        
        window.loadIssuesList = async function() {
            try {
                if (!window.firebaseTest || !window.firebaseTest.getCurrentUser()) {
                    console.log('âš ï¸ Firebaseæœªæ¥ç¶šã¾ãŸã¯æœªãƒ­ã‚°ã‚¤ãƒ³ - èª²é¡Œãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¹ã‚­ãƒƒãƒ—');
                    return;
                }
                
                console.log('ğŸ“– èª²é¡Œãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹');
                const user = window.firebaseTest.getCurrentUser();
                const issuesRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/issues_list`);
                const snapshot = await window.firebaseTest.get(issuesRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    issuesList = Object.values(data).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    window.issuesList = issuesList;
                    console.log('âœ… èª²é¡Œãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿æˆåŠŸ:', issuesList.length, 'ä»¶');
                } else {
                    issuesList = [];
                    window.issuesList = issuesList;
                    console.log('ğŸ“­ èª²é¡Œãƒªã‚¹ãƒˆãªã—');
                }
                
                displayIssuesList();
                
            } catch (error) {
                console.error('âŒ èª²é¡Œãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error.message);
            }
        };
        
        // èª²é¡Œãƒªã‚¹ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ã¨ãã®ä»–ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function displayIssuesList(searchQuery = '') {
            console.log('ğŸ–¼ï¸ displayIssuesListé–‹å§‹');
            
            const listContainer = document.getElementById('issue-list');
            if (!listContainer) return;
            
            // ğŸ” æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå…±é€šé–¢æ•°ä½¿ç”¨ï¼‰
            let filteredIssuesList = window.universalSearch(issuesList, searchQuery, ['title', 'content', 'project']);
            
            if (filteredIssuesList.length === 0) {
                listContainer.innerHTML = searchQuery ? 
                    `<div style="text-align: center; padding: 20px; color: #666;">ã€Œ${searchQuery}ã€ã«ä¸€è‡´ã™ã‚‹èª²é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>` :
                    '<div style="text-align: center; padding: 20px; color: #666;">èª²é¡Œãƒªã‚¹ãƒˆã¯ç©ºã§ã™</div>';
                return;
            }
            
            const priorityColors = { 'high': '#f44336', 'medium': '#FF9800', 'low': '#4CAF50' };
            const priorityLabels = { 'high': 'ğŸ”¥ é«˜', 'medium': 'ğŸ“‹ ä¸­', 'low': 'ğŸ’¤ ä½' };
            const projectLabels = { 'novel-ai': 'ğŸ¨ Novel AI', 'yarakashi': 'ğŸš¨ ã‚„ã‚‰ã‹ã—ç®¡ç†', 'claude-code': 'ğŸ’» Claude Code', 'other': 'ğŸ”§ ãã®ä»–' };
            
            const html = filteredIssuesList.map(issue => {
                const escapeHtml = (text) => text.replace(/[&<>"'`]/g, char => `&#${char.charCodeAt(0)};`);
                const firstLine = issue.content.split('\n')[0];
                const statusButton = issue.status === 'open' ? 
                    `<button onclick="resolveIssue('${issue.id}')" style="background: #4CAF50; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">å®Œäº†</button>` : 
                    `<button onclick="reopenIssue('${issue.id}')" style="background: #FF9800; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">å†ã‚ªãƒ¼ãƒ—ãƒ³</button>`;
                
                return `<div class="issue-item" style="background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${priorityColors[issue.priority]};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-size: 1.1rem; font-weight: 600; color: #333;">${escapeHtml(issue.title)}</div>
                        <div style="font-size: 11px; color: #999;">${issue.content.split('\n').length}è¡Œ | ${issue.content.length}æ–‡å­—</div>
                    </div>
                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                        ğŸ“… ${new Date(issue.timestamp).toLocaleDateString('ja-JP')} 
                        ${priorityLabels[issue.priority]} | ${projectLabels[issue.project]}
                        ${issue.status === 'closed' ? 'âœ… å®Œäº†æ¸ˆã¿' : 'ğŸ”„ ã‚ªãƒ¼ãƒ—ãƒ³'}
                    </div>
                    <div style="color: #666; font-size: 14px; margin: 8px 0;">
                        ${escapeHtml(firstLine)}${issue.content.split('\n').length > 1 ? ' ...' : ''}
                    </div>
                    <div style="margin-top: 10px;">
                        <button onclick="toggleIssueContent('${issue.id}')" style="background: #2196F3; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                            <span id="toggle-text-${issue.id}">è©³ç´°è¡¨ç¤º</span>
                        </button>
                        ${statusButton}
                        <button onclick="deleteIssue('${issue.id}')" style="background: #f44336; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px;">å‰Šé™¤</button>
                    </div>
                    <div id="full-content-${issue.id}" style="display: none; margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 6px; font-size: 14px;">
                        ${escapeHtml(issue.content).replace(/\n/g, '<br>')}
                    </div>
                </div>`;
            }).join('');
            
            listContainer.innerHTML = html;
        }
        
        window.filterIssueList = function() {
            const searchInput = document.getElementById('issue-search');
            const searchQuery = searchInput ? searchInput.value.trim() : '';
            displayIssuesList(searchQuery);
        };
        
        window.toggleIssueContent = function(itemId) {
            const fullContentElement = document.getElementById(`full-content-${itemId}`);
            const toggleTextElement = document.getElementById(`toggle-text-${itemId}`);
            
            if (fullContentElement && toggleTextElement) {
                const isHidden = fullContentElement.style.display === 'none';
                fullContentElement.style.display = isHidden ? 'block' : 'none';
                toggleTextElement.textContent = isHidden ? 'è©³ç´°éè¡¨ç¤º' : 'è©³ç´°è¡¨ç¤º';
            }
        };
        
        window.resolveIssue = async function(id) { await updateIssueStatus(id, 'closed'); };
        window.reopenIssue = async function(id) { await updateIssueStatus(id, 'open'); };
        
        async function updateIssueStatus(id, status) {
            try {
                const issue = issuesList.find(i => i.id == id);
                if (!issue) return;
                
                issue.status = status;
                
                if (window.firebaseTest && window.firebaseTest.getCurrentUser()) {
                    const user = window.firebaseTest.getCurrentUser();
                    const issueRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/issues_list/${id}`);
                    await window.firebaseTest.set(issueRef, issue);
                }
                
                displayIssuesList();
                console.log('âœ… èª²é¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°:', status);
                
            } catch (error) {
                console.error('âŒ èª²é¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error.message);
                alert('âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        window.deleteIssue = async function(id) {
            if (!confirm('ã“ã®èª²é¡Œã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
            
            try {
                if (window.firebaseTest && window.firebaseTest.getCurrentUser()) {
                    const user = window.firebaseTest.getCurrentUser();
                    const issueRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/issues_list/${id}`);
                    await window.firebaseTest.set(issueRef, null);
                }
                
                issuesList = issuesList.filter(i => i.id !== id);
                window.issuesList = issuesList;
                displayIssuesList();
                console.log('âœ… èª²é¡Œå‰Šé™¤å®Œäº†');
                
            } catch (error) {
                console.error('âŒ èª²é¡Œå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error.message);
                alert('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        };
        
        // Claude Code ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†æ©Ÿèƒ½
        let claudePrompts = [];
        window.claudePrompts = claudePrompts;
        
        window.loadClaudePrompts = async function() {
            try {
                if (!window.firebaseTest || !window.firebaseTest.getCurrentUser()) {
                    console.log('âš ï¸  ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                console.log('ğŸ“– Claude ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹');
                const user = window.firebaseTest.getCurrentUser();
                const promptsRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/claude_prompts`);
                const snapshot = await window.firebaseTest.get(promptsRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    claudePrompts = Object.values(data).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    window.claudePrompts = claudePrompts;
                    console.log('âœ… Claude ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿æˆåŠŸ:', claudePrompts.length, 'ä»¶');
                } else {
                    claudePrompts = [];
                    window.claudePrompts = claudePrompts;
                    console.log('ğŸ“­ Claude ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãªã—');
                }
                
                displayClaudePrompts();
                
            } catch (error) {
                console.error('âŒ Claude ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error.message);
            }
        };
        
        window.addClaudePrompt = async function() {
            try {
                const prompt = document.getElementById('claude-prompt').value.trim();
                const category = document.getElementById('claude-category').value;
                
                if (!prompt) {
                    alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                const claudePrompt = {
                    id: `claude_${Date.now()}_${Math.floor(Math.random() * 10000)}`,
                    prompt,
                    category,
                    timestamp: new Date().toISOString(),
                    useCount: 0
                };
                
                console.log('ğŸ’» Claude ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¿½åŠ é–‹å§‹:', category);
                
                if (window.firebaseTest && window.firebaseTest.getCurrentUser()) {
                    const user = window.firebaseTest.getCurrentUser();
                    const promptRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/claude_prompts/${claudePrompt.id}`);
                    await window.firebaseTest.set(promptRef, claudePrompt);
                    console.log('âœ… Firebaseä¿å­˜æˆåŠŸ');
                }
                
                claudePrompts.push(claudePrompt);
                document.getElementById('claude-prompt').value = '';
                displayClaudePrompts();
                console.log('âœ… Claude ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¿½åŠ å®Œäº†');
                
            } catch (error) {
                console.error('âŒ Claude ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¿½åŠ ã‚¨ãƒ©ãƒ¼:', error.message);
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        };
        
        function displayClaudePrompts(searchQuery = '') {
            console.log('ğŸ–¼ï¸ displayClaudePromptsé–‹å§‹, searchQuery:', searchQuery);
            const listContainer = document.getElementById('claude-prompt-list');
            const totalCountElement = document.getElementById('claude-total-count');
            const searchResultElement = document.getElementById('claude-search-result');
            
            console.log('ğŸ” listContainer:', listContainer);
            console.log('ğŸ” claudePrompts.length:', claudePrompts.length);
            console.log('ğŸ” claudePromptsæ§‹é€ :', claudePrompts.map(p => ({ id: p.id, hasContent: !!p.content, hasCategory: !!p.category, keys: Object.keys(p) })));
            
            if (!listContainer) {
                console.error('âŒ claude-prompt-listè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ğŸ” æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå…±é€šé–¢æ•°ä½¿ç”¨ï¼‰
            let filteredPrompts = window.universalSearch(claudePrompts, searchQuery, ['prompt', 'category']);
            
            // ğŸ“Š æ¤œç´¢çµæœè¡¨ç¤ºæ›´æ–°
            if (totalCountElement) totalCountElement.textContent = filteredPrompts.length;
            if (searchResultElement) {
                searchResultElement.innerHTML = searchQuery ? 
                    `æ¤œç´¢çµæœ: <span style="color: #7B68EE; font-weight: bold;">${filteredPrompts.length}</span> ä»¶ / å…¨ ${claudePrompts.length} ä»¶` :
                    `å…¨ <span id="claude-total-count">${claudePrompts.length}</span> ä»¶`;
            }
            
            if (filteredPrompts.length === 0) {
                const message = searchQuery ? 
                    `<div style="text-align: center; padding: 20px; color: #666;">ã€Œ${searchQuery}ã€ã«ä¸€è‡´ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>` :
                    '<div style="text-align: center; padding: 20px; color: #666;">Claude Codeãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒªã‚¹ãƒˆã¯ç©ºã§ã™</div>';
                listContainer.innerHTML = message;
                return;
            }
            
            const html = filteredPrompts.map(prompt => `
                <div style="background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #7B68EE;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                        <span style="background: #7B68EE; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">${prompt.category}</span>
                        <span style="color: #666; font-size: 0.9em;">${new Date(prompt.timestamp).toLocaleDateString('ja-JP')} ä½¿ç”¨å›æ•°: ${prompt.useCount}</span>
                    </div>
                    <div style="white-space: pre-wrap; line-height: 1.5; margin-bottom: 10px;">${prompt.prompt}</div>
                    <div>
                        <button onclick="copyClaudePrompt('${prompt.id}')" style="background: #4CAF50; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                        <button onclick="deleteClaudePrompt('${prompt.id}')" style="background: #f44336; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸ å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
            
            listContainer.innerHTML = html;
        }
        
        // ğŸ” Claude ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
        window.filterClaudePrompts = function() {
            console.log('ğŸ” filterClaudePromptså®Ÿè¡Œé–‹å§‹');
            const searchInput = document.getElementById('claude-search');
            const searchQuery = searchInput ? searchInput.value.trim() : '';
            console.log('ğŸ” æ¤œç´¢ã‚¯ã‚¨ãƒª:', searchQuery);
            console.log('ğŸ” Claude ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·æ•°:', claudePrompts.length);
            displayClaudePrompts(searchQuery);
        };
        
        // æ¤œç´¢ã‚¯ãƒªã‚¢æ©Ÿèƒ½
        window.clearClaudeSearch = function() {
            const searchInput = document.getElementById('claude-search');
            if (searchInput) {
                searchInput.value = '';
                displayClaudePrompts('');
            }
        };
        
        // ã‚„ã‚‰ã‹ã—ç®¡ç†æ¤œç´¢ã‚¯ãƒªã‚¢æ©Ÿèƒ½
        window.clearYarakashiSearch = function() {
            const searchInput = document.getElementById('yarakashi-search');
            if (searchInput) {
                searchInput.value = '';
                displayYarakashiList('');
            }
        };
        
        // èª²é¡Œãƒªã‚¹ãƒˆæ¤œç´¢ã‚¯ãƒªã‚¢æ©Ÿèƒ½
        window.clearIssueSearch = function() {
            const searchInput = document.getElementById('issue-search');
            if (searchInput) {
                searchInput.value = '';
                displayIssuesList('');
            }
        };
        
        window.copyClaudePrompt = async function(id) {
            const prompt = claudePrompts.find(p => p.id == id);
            if (!prompt) return;
            
            try {
                await navigator.clipboard.writeText(prompt.prompt);
                
                // ä½¿ç”¨å›æ•°ã‚’å¢—ã‚„ã™
                prompt.useCount++;
                if (window.firebaseTest && window.firebaseTest.getCurrentUser()) {
                    const user = window.firebaseTest.getCurrentUser();
                    const promptRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/claude_prompts/${id}`);
                    await window.firebaseTest.set(promptRef, prompt);
                }
                
                displayClaudePrompts();
                console.log('ğŸ“‹ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚³ãƒ”ãƒ¼å®Œäº†:', prompt.category);
                
                // é€šçŸ¥è¡¨ç¤º
                showNotification('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
                
            } catch (error) {
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                console.error('âŒ ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', error.message);
            }
        };
        
        window.deleteClaudePrompt = async function(id) {
            if (!confirm('ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                claudePrompts = claudePrompts.filter(p => p.id != id);
                
                if (window.firebaseTest && window.firebaseTest.getCurrentUser()) {
                    const user = window.firebaseTest.getCurrentUser();
                    const promptRef = window.firebaseTest.ref(window.firebaseTest.database, `users/${user.uid}/claude_prompts/${id}`);
                    await window.firebaseTest.set(promptRef, null);
                }
                
                displayClaudePrompts();
                console.log('âœ… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå‰Šé™¤å®Œäº†');
                
            } catch (error) {
                console.error('âŒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error.message);
            }
        };
    </script>
</body>
</html>